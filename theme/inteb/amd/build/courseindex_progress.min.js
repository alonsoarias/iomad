define(["jquery","core/ajax","core/log"],function(a,b,c){var d=null,e="courseindex_expanded_sections_",f=function(a){return e+a},g=function(a){try{var b=f(a),d=localStorage.getItem(b);if(d)return JSON.parse(d)}catch(a){c.debug("courseindex_progress: Error reading from localStorage",a)}return[]},h=function(a,b){try{var d=f(a);localStorage.setItem(d,JSON.stringify(b))}catch(a){c.debug("courseindex_progress: Error saving to localStorage",a)}},i=function(a,b){var d=g(a);-1===d.indexOf(b)&&(d.push(b),h(a,d),c.debug("courseindex_progress: Section "+b+" added to expanded list"))},j=function(a,b){var d=g(a),e=d.indexOf(b);e>-1&&(d.splice(e,1),h(a,d),c.debug("courseindex_progress: Section "+b+" removed from expanded list"))},k=function(b){var d=g(b);0===d.length?c.debug("courseindex_progress: No saved expanded sections found"):(c.debug("courseindex_progress: Restoring "+d.length+" expanded sections"),d.forEach(function(b){var d=a("#course-index-collapse"+b),e=a('.course-index-toggle[data-section-number="'+b+'"]');d.length>0&&(d.addClass("show"),e.removeClass("collapsed").attr("aria-expanded","true"),c.debug("courseindex_progress: Restored section "+b))}))},l=function(b){a(document).on("shown.bs.collapse",".course-index-content",function(){var c=a(this).data("section-number");void 0!==c&&i(b,parseInt(c,10))}),a(document).on("hidden.bs.collapse",".course-index-content",function(){var c=a(this).data("section-number");void 0!==c&&j(b,parseInt(c,10))}),c.debug("courseindex_progress: Section collapse listeners setup complete")},m=function(b){c.debug("courseindex_progress: Initializing for course "+b),n(b),u(b);var d=setInterval(function(){var c=a(".course-index-section");c.length>0&&(clearInterval(d),A(b),k(b),l(b))},500);a(document).on("state-changed",function(){c.debug("courseindex_progress: State changed event detected"),w(b),A(b)}),a(document).on("core_completion:activity_completed",function(){c.debug("courseindex_progress: Activity completion detected"),setTimeout(function(){w(b),n(b),A(b)},500)})},n=function(a){var d=b.call([{methodname:"theme_inteb_get_course_progress",args:{courseid:a}}]);d[0].then(function(a){return c.debug("courseindex_progress: Course progress loaded",a),o(),a&&a.hasprogress?a.hasactivitiestracking===!1?void r(a.caneditcourse):(p(a),void q()):void s()}).catch(function(a){a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading course progress: "+a.message)})},o=function(){a("#courseindex-progress-header").hide(),a("#courseindex-no-tracking").hide(),a("#courseindex-no-activities-tracking-teacher").hide(),a("#courseindex-no-activities-tracking-student").hide(),a("#courseindex-icon-legend").hide()},p=function(b){var c=a("#courseindex-progress-header");if(0===c.length)return;var d=b.percentage||0;c.find('[data-region="course-percentage"]').text(d+"%");var e=c.find('[data-region="course-progress-bar"]');e.length>0&&(e.css("width",d+"%").attr("aria-valuenow",d),e.removeClass("progress-0 progress-low progress-medium progress-high progress-complete"),0===d?e.addClass("progress-0"):d<40?e.addClass("progress-low"):d<70?e.addClass("progress-medium"):d<100?e.addClass("progress-high"):e.addClass("progress-complete")),c.fadeIn(300)},q=function(){a("#courseindex-icon-legend").fadeIn(300)},s=function(){a("#courseindex-no-tracking").fadeIn(300)},r=function(b){b?a("#courseindex-no-activities-tracking-teacher").fadeIn(300):a("#courseindex-no-activities-tracking-student").fadeIn(300)},u=function(b){var d=0,e=20,f=setInterval(function(){d++;var g=a(".activity-status-icon[data-cm-id]");g.length>0?(c.debug("courseindex_progress: Found "+g.length+" activities in DOM"),clearInterval(f),w(b)):d>=e&&(c.debug("courseindex_progress: Timeout waiting for activities, attempting load anyway"),clearInterval(f),w(b))},500)},w=function(a){c.debug("courseindex_progress: Loading activities completion for course "+a);var e=b.call([{methodname:"theme_inteb_get_activities_completion",args:{courseid:a}}]);e[0].then(function(a){return c.debug("courseindex_progress: Activities completion loaded",a),a&&a.activities&&(d=a.activities,x(a.activities)),!0}).catch(function(a){a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading activities completion: "+a.message)})},x=function(b){var e=0,f=0;b.forEach(function(b){var c=a('.activity-status-icon[data-cm-id="'+b.cmid+'"]');if(0===c.length)return void f++;c.removeClass("status-not-started status-in-progress status-completed");var g="",h="";2===b.state?(g="status-completed",h="Completed"):1===b.state?(g="status-in-progress",h="In progress"):(g="status-not-started",h="Not started"),c.addClass(g),c.attr("aria-label",h),e++}),c.debug("courseindex_progress: Updated "+e+" activity icons, "+f+" not found in DOM"),f>0&&d&&setTimeout(function(){x(d)},1e3)},A=function(b){a(".section-percentage").each(function(){var c=a(this),d=c.data("section-id");d&&!c.data("loaded")&&B(b,d,c)})},B=function(a,d,e){var f=b.call([{methodname:"theme_inteb_get_section_progress",args:{sectionid:d,courseid:a}}]);f[0].then(function(a){if(e.data("loaded",!0),a&&a.hasprogress&&a.total>0){var b=a.percentage||0;e.text(b+"%"),e.fadeIn(200)}return!0}).catch(function(a){e.data("loaded",!0),a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading section progress: "+a.message)})};return{init:m}});
//# sourceMappingURL=courseindex_progress.min.js.map
