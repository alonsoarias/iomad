define(["jquery","core/ajax","core/log"],function(a,b,c){var d=null,e=function(b){c.debug("courseindex_progress: Initializing for course "+b),f(b),i(b);var d=setInterval(function(){var c=a(".course-index-section");c.length>0&&(clearInterval(d),r(b))},500);a(document).on("state-changed",function(){c.debug("courseindex_progress: State changed event detected"),k(b),r(b)}),a(document).on("core_completion:activity_completed",function(){c.debug("courseindex_progress: Activity completion detected"),setTimeout(function(){k(b),f(b),r(b)},500)})},f=function(a){var d=b.call([{methodname:"theme_compecer_get_course_progress",args:{courseid:a}}]);d[0].then(function(a){return c.debug("courseindex_progress: Course progress loaded",a),a&&a.hasprogress?(g(a),h()):j(),!0}).catch(function(a){a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading course progress: "+a.message)})},g=function(b){var c=a("#courseindex-progress-header");if(0===c.length)return;var d=b.percentage||0;c.find('[data-region="course-percentage"]').text(d+"%");var e=c.find('[data-region="course-progress-bar"]');e.length>0&&(e.css("width",d+"%").attr("aria-valuenow",d),e.removeClass("progress-0 progress-low progress-medium progress-high progress-complete"),0===d?e.addClass("progress-0"):d<40?e.addClass("progress-low"):d<70?e.addClass("progress-medium"):d<100?e.addClass("progress-high"):e.addClass("progress-complete")),c.fadeIn(300)},h=function(){a("#courseindex-icon-legend").fadeIn(300)},j=function(){a("#courseindex-no-tracking").fadeIn(300)},i=function(b){var d=0,e=20,f=setInterval(function(){d++;var g=a(".activity-status-icon[data-cm-id]");g.length>0?(c.debug("courseindex_progress: Found "+g.length+" activities in DOM"),clearInterval(f),k(b)):d>=e&&(c.debug("courseindex_progress: Timeout waiting for activities, attempting load anyway"),clearInterval(f),k(b))},500)},k=function(a){c.debug("courseindex_progress: Loading activities completion for course "+a);var d=b.call([{methodname:"theme_compecer_get_activities_completion",args:{courseid:a}}]);d[0].then(function(a){return c.debug("courseindex_progress: Activities completion loaded",a),a&&a.activities&&(d=a.activities,l(a.activities)),!0}).catch(function(a){a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading activities completion: "+a.message)})},l=function(b){var e=0,f=0;b.forEach(function(b){var c=a('.activity-status-icon[data-cm-id="'+b.cmid+'"]');if(0===c.length)return void f++;c.removeClass("status-not-started status-in-progress status-completed");var d="",g="";2===b.state?(d="status-completed",g="Completed"):1===b.state?(d="status-in-progress",g="In progress"):(d="status-not-started",g="Not started"),c.addClass(d),c.attr("aria-label",g),e++}),c.debug("courseindex_progress: Updated "+e+" activity icons, "+f+" not found in DOM"),f>0&&d&&setTimeout(function(){l(d)},1e3)},r=function(b){a(".section-percentage").each(function(){var c=a(this),d=c.data("section-id");d&&!c.data("loaded")&&s(b,d,c)})},s=function(a,d,e){var f=b.call([{methodname:"theme_compecer_get_section_progress",args:{sectionid:d,courseid:a}}]);f[0].then(function(a){if(e.data("loaded",!0),a&&a.hasprogress&&a.total>0){var b=a.percentage||0;e.text(b+"%"),e.fadeIn(200)}return!0}).catch(function(a){e.data("loaded",!0),a&&"nopermissions"!==a.errorcode&&c.error("courseindex_progress: Error loading section progress: "+a.message)})};return{init:e}});
//# sourceMappingURL=courseindex_progress.min.js.map
