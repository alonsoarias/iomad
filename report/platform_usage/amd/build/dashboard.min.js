/**
 * Platform Usage Report - Dashboard JavaScript Module
 *
 * @module     report_platform_usage/dashboard
 * @copyright  2024 IOMAD
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_platform_usage/dashboard",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){var Dashboard={config:{ajaxUrl:"",courseId:0,inCourseContext:!1,sesskey:""},charts:{},currentData:{},strings:{},colors:{brand:{primary:"#6366f1",primaryLight:"#818cf8",primaryDark:"#4f46e5"},success:{primary:"#10b981",light:"#34d399"},warning:{primary:"#f59e0b",light:"#fbbf24"},info:{primary:"#06b6d4",light:"#22d3ee"},error:{primary:"#f43f5e",light:"#fb7185"},gray:{50:"#f8fafc",100:"#f1f5f9",200:"#e2e8f0",500:"#64748b",700:"#334155",900:"#0f172a"}},init:function(config,initialData,strings){this.config=$.extend(this.config,config),this.currentData=initialData,this.strings=strings,this.setupChartDefaults(),this.initCharts(initialData),this.bindEvents(),this.initTooltips()},setupChartDefaults:function(){"undefined"!=typeof Chart&&(Chart.defaults.font.family="'Inter', system-ui, -apple-system, sans-serif",Chart.defaults.font.size=12,Chart.defaults.color=this.colors.gray[500],Chart.defaults.plugins.legend.labels.usePointStyle=!0,Chart.defaults.plugins.legend.labels.padding=16,Chart.defaults.plugins.tooltip.backgroundColor=this.colors.gray[900],Chart.defaults.plugins.tooltip.titleColor="#ffffff",Chart.defaults.plugins.tooltip.bodyColor="#e2e8f0",Chart.defaults.plugins.tooltip.borderColor=this.colors.gray[700],Chart.defaults.plugins.tooltip.borderWidth=1,Chart.defaults.plugins.tooltip.padding=12,Chart.defaults.plugins.tooltip.cornerRadius=8,Chart.defaults.plugins.tooltip.displayColors=!0,Chart.defaults.plugins.tooltip.boxPadding=4)},initTooltips:function(){$('[data-toggle="tooltip"]').tooltip({container:"body",html:!0,trigger:"hover focus"}),$(document).on("shown.bs.tab",(function(){$('[data-toggle="tooltip"]').tooltip("dispose").tooltip({container:"body",html:!0,trigger:"hover focus"})}))},bindEvents:function(){var self=this;$("#apply-global-filter").on("click",(function(){var companyId=$("#companyid").val()||0,datefrom=$("#global-datefrom").val(),dateto=$("#global-dateto").val();self.loadReportData(companyId,datefrom,dateto)})),$("#companyid").on("change",(function(){var companyId=$(this).val(),datefrom=$("#global-datefrom").val(),dateto=$("#global-dateto").val();self.loadReportData(companyId,datefrom,dateto)})),$("#apply-course-filter").on("click",(function(){var datefrom=$("#course-datefrom").val(),dateto=$("#course-dateto").val();self.loadCourseReportData(datefrom,dateto)}))},initCharts:function(data){var self=this;Object.keys(this.charts).forEach((function(key){self.charts[key]&&"function"==typeof self.charts[key].destroy&&self.charts[key].destroy()})),this.charts={},this.createDailyLoginsChart(data),this.createUserActivityChart(data),this.createCourseAccessChart(data),this.createCompletionTrendsChart(data),this.createDedicationChart(data)},createDailyLoginsChart:function(data){var canvas=document.getElementById("dailyLoginsChart");if(canvas&&data.daily_logins&&data.daily_logins.labels){var ctx=canvas.getContext("2d");this.charts.dailyLogins=new Chart(ctx,{type:"line",data:{labels:data.daily_logins.labels,datasets:[{label:this.strings.logins||"Logins",data:data.daily_logins.logins,borderColor:this.colors.brand.primary,backgroundColor:"rgba(99, 102, 241, 0.1)",fill:!0,tension:.4},{label:this.strings.uniqueusers||"Unique users",data:data.daily_logins.unique_users,borderColor:this.colors.success.primary,backgroundColor:"rgba(16, 185, 129, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}},createUserActivityChart:function(data){var canvas=document.getElementById("userActivityChart");if(canvas){var activeUsers,inactiveUsers;if(this.config.inCourseContext&&data.course_stats)activeUsers=data.course_stats.active_users||0,inactiveUsers=data.course_stats.inactive_users||0;else{if(!data.user_summary)return;activeUsers=data.user_summary.active||0,inactiveUsers=data.user_summary.inactive||0}var ctx=canvas.getContext("2d");this.charts.userActivity=new Chart(ctx,{type:"doughnut",data:{labels:[this.strings.activeusers||"Active users",this.strings.inactiveusers||"Inactive users"],datasets:[{data:[activeUsers,inactiveUsers],backgroundColor:[this.colors.success.primary,this.colors.error.primary],hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"}}}})}},createCourseAccessChart:function(data){var canvas=document.getElementById("courseAccessChart");if(canvas&&data.course_access_trends&&data.course_access_trends.labels){var ctx=canvas.getContext("2d");this.charts.courseAccess=new Chart(ctx,{type:"line",data:{labels:data.course_access_trends.labels,datasets:[{label:this.strings.courseaccesses||"Course accesses",data:data.course_access_trends.data,borderColor:this.colors.warning.primary,backgroundColor:"rgba(245, 158, 11, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}},createCompletionTrendsChart:function(data){var canvas=document.getElementById("completionTrendsChart");if(canvas&&data.completion_trends&&data.completion_trends.labels){var ctx=canvas.getContext("2d");this.charts.completionTrends=new Chart(ctx,{type:"line",data:{labels:data.completion_trends.labels,datasets:[{label:this.strings.completions||"Completions",data:data.completion_trends.data,borderColor:this.colors.info.primary,backgroundColor:"rgba(6, 182, 212, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0}}}})}},createDedicationChart:function(data){var canvas=document.getElementById("dedicationChart");if(canvas&&data.top_dedication&&0!==data.top_dedication.length){var ctx=canvas.getContext("2d");this.charts.dedication=new Chart(ctx,{type:"bar",data:{labels:data.top_dedication.map((function(c){var name=c.shortname||c.fullname||"";return name.length>18?name.substring(0,15)+"...":name})),datasets:[{label:this.strings.dedicationpercent||"Share",data:data.top_dedication.map((function(c){return c.dedication_percent})),backgroundColor:this.colors.brand.primary,borderColor:this.colors.brand.primaryDark,borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,max:100,ticks:{callback:function(value){return value+"%"}}}}}})}},loadReportData:function(companyId,datefrom,dateto){var self=this,$loading=$("#loading-indicator");$loading.show();var datefromTs=new Date(datefrom).getTime()/1e3,datetoTs=new Date(dateto).getTime()/1e3+86399;$.ajax({url:this.config.ajaxUrl,method:"GET",data:{companyid:companyId,datefrom:Math.floor(datefromTs),dateto:Math.floor(datetoTs)},dataType:"json"}).done((function(data){self.currentData=data,self.updateSummaryCards(data),self.initCharts(data),self.updateTables(data),self.updateExportLinks(companyId,datefrom,dateto)})).fail((function(jqXHR,textStatus,errorThrown){Notification.exception({message:"Error loading report data: "+errorThrown})})).always((function(){$loading.hide()}))},loadCourseReportData:function(datefrom,dateto){var self=this,$loading=$("#course-loading-indicator");$loading.show();var datefromTs=new Date(datefrom).getTime()/1e3,datetoTs=new Date(dateto).getTime()/1e3+86399;$.ajax({url:this.config.ajaxUrl,method:"GET",data:{courseid:this.config.courseId,datefrom:Math.floor(datefromTs),dateto:Math.floor(datetoTs)},dataType:"json"}).done((function(data){self.currentData=data,self.updateSummaryCards(data),self.initCharts(data),self.updateTables(data),self.updateCourseExportLinks(datefrom,dateto)})).fail((function(jqXHR,textStatus,errorThrown){Notification.exception({message:"Error loading course data: "+errorThrown})})).always((function(){$loading.hide()}))},updateSummaryCards:function(data){if(this.updateElement("logins-today",this.formatNumber(data.login_summary.logins_today)),this.updateElement("logins-week",this.formatNumber(data.login_summary.logins_week)),this.updateElement("logins-month",this.formatNumber(data.login_summary.logins_month)),this.updateElement("unique-month",this.formatNumber(data.login_summary.unique_users_month)),this.updateElement("unique-week",this.formatNumber(data.login_summary.unique_users_week)),data.user_summary&&(this.updateElement("total-users",this.formatNumber(data.user_summary.total)),this.updateElement("active-users",this.formatNumber(data.user_summary.active)),this.updateElement("inactive-users",this.formatNumber(data.user_summary.inactive))),data.completions_summary&&(this.updateElement("completions-today",this.formatNumber(data.completions_summary.completions_today)),this.updateElement("completions-week",this.formatNumber(data.completions_summary.completions_week)),this.updateElement("completions-month",this.formatNumber(data.completions_summary.completions_month)),this.updateElement("total-completions",this.formatNumber(data.completions_summary.total_completions))),data.daily_users&&data.daily_users.data){var maxDaily=Math.max.apply(null,data.daily_users.data)||0,sum=data.daily_users.data.reduce((function(a,b){return a+b}),0),avgDaily=data.daily_users.data.length>0?Math.round(sum/data.daily_users.data.length):0,todayDaily=data.daily_users.data[data.daily_users.data.length-1]||0;this.updateElement("daily-today",this.formatNumber(todayDaily)),this.updateElement("daily-avg",this.formatNumber(avgDaily)),this.updateElement("daily-max",this.formatNumber(maxDaily))}data.course_stats&&this.updateElement("course-accesses",this.formatNumber(data.course_stats.accesses||0))},updateTables:function(data){this.updateCoursesTable(data.top_courses||[]),this.updateActivitiesTable(data.top_activities||[]),this.updateDailyUsersTable(data.daily_users||{})},updateCoursesTable:function(courses){var $container=$("#top-courses-table");if($container.length)if(0!==courses.length){var html='<div class="table-responsive"><table class="table table-striped table-sm">';html+='<thead class="thead-light"><tr>',html+="<th>"+(this.strings.coursename||"Course")+"</th>",html+='<th class="text-right">'+(this.strings.courseaccesses||"Accesses")+"</th>",html+='<th class="text-right">'+(this.strings.uniqueusers||"Unique users")+"</th>",html+="</tr></thead><tbody>";var self=this;courses.forEach((function(course){html+="<tr>",html+="<td>"+self.escapeHtml(course.fullname)+"</td>",html+='<td class="text-right">'+self.formatNumber(course.access_count)+"</td>",html+='<td class="text-right">'+self.formatNumber(course.unique_users)+"</td>",html+="</tr>"})),html+="</tbody></table></div>",$container.html(html)}else $container.html('<p class="text-muted">'+(this.strings.nodata||"No data")+"</p>")},updateActivitiesTable:function(activities){var $container=$("#top-activities-table");if($container.length)if(0!==activities.length){var html='<div class="table-responsive"><table class="table table-striped table-sm">';html+='<thead class="thead-light"><tr>',html+="<th>"+(this.strings.activityname||"Activity")+"</th>",html+="<th>"+(this.strings.activitytype||"Type")+"</th>",html+='<th class="text-right">'+(this.strings.activityaccesses||"Views")+"</th>",html+='<th class="text-right">'+(this.strings.uniqueusers||"Unique users")+"</th>",html+="</tr></thead><tbody>";var self=this;activities.forEach((function(activity){html+="<tr>",html+="<td>"+self.escapeHtml(activity.name)+"</td>",html+='<td><span class="badge badge-secondary">',html+=self.escapeHtml(activity.type_name||activity.type)+"</span></td>",html+='<td class="text-right">'+self.formatNumber(activity.access_count)+"</td>",html+='<td class="text-right">'+self.formatNumber(activity.unique_users)+"</td>",html+="</tr>"})),html+="</tbody></table></div>",$container.html(html)}else $container.html('<p class="text-muted">'+(this.strings.nodata||"No data")+"</p>")},updateDailyUsersTable:function(dailyUsers){var $container=$("#daily-users-table");if($container.length&&dailyUsers.records)if(0!==dailyUsers.records.length){var html='<div class="table-responsive" style="max-height: 250px; overflow-y: auto;">';html+='<table class="table table-striped table-sm mb-0">',html+='<thead class="thead-light" style="position: sticky; top: 0;"><tr>',html+="<th>"+(this.strings.date||"Date")+"</th>",html+='<th class="text-right">'+(this.strings.uniqueusers||"Unique users")+"</th>",html+="</tr></thead><tbody>";var self=this;dailyUsers.records.forEach((function(record){html+="<tr>",html+="<td>"+record.fecha_formateada+"</td>",html+='<td class="text-right"><span class="badge badge-primary">',html+=self.formatNumber(record.cantidad_usuarios)+"</span></td>",html+="</tr>"})),html+="</tbody></table></div>",$container.html(html)}else $container.html('<p class="text-muted p-3">'+(this.strings.nodata||"No data")+"</p>")},updateExportLinks:function(companyId,datefrom,dateto){var datefromTs=Math.floor(new Date(datefrom).getTime()/1e3),datetoTs=Math.floor(new Date(dateto).getTime()/1e3+86399);$("#export-excel, #export-csv").each((function(){var $link=$(this),url=$link.attr("href");url=(url=(url=url.replace(/companyid=\d+/,"companyid="+companyId)).replace(/datefrom=\d+/,"datefrom="+datefromTs)).replace(/dateto=\d+/,"dateto="+datetoTs),$link.attr("href",url)}))},updateCourseExportLinks:function(datefrom,dateto){var datefromTs=Math.floor(new Date(datefrom).getTime()/1e3),datetoTs=Math.floor(new Date(dateto).getTime()/1e3+86399);$("#export-excel-course, #export-csv-course").each((function(){var $link=$(this),url=$link.attr("href");url=(url=url.replace(/datefrom=\d+/,"datefrom="+datefromTs)).replace(/dateto=\d+/,"dateto="+datetoTs),$link.attr("href",url)}))},updateElement:function(id,value){var $el=$("#"+id);$el.length&&$el.text(value)},formatNumber:function(num){return null==num?"0":num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},escapeHtml:function(text){if(!text)return"";var div=document.createElement("div");return div.textContent=text,div.innerHTML}};return{init:function(config,initialData,strings){Dashboard.init(config,initialData,strings)}}}));

//# sourceMappingURL=dashboard.min.js.map