{"version":3,"file":"convocatoria_loader.min.js","sources":["../src/convocatoria_loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for dynamic convocatoria loading with autocomplete/search functionality.\n *\n * This module provides AJAX-based convocatoria selection for forms and filters.\n *\n * @module     local_jobboard/convocatoria_loader\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str'], function($, Str) {\n    'use strict';\n\n    /**\n     * Load convocatorias via AJAX.\n     *\n     * @param {Object} params Search parameters.\n     * @param {string} params.search Optional search term.\n     * @param {number} params.id Optional specific convocatoria ID to load.\n     * @param {number} params.companyid Optional company ID filter.\n     * @param {string} params.status Optional status filter.\n     * @param {boolean} params.includeall Include all statuses.\n     * @return {Promise} Promise resolving to array of convocatorias.\n     */\n    var loadConvocatorias = function(params) {\n        params = params || {};\n\n        return new Promise(function(resolve, reject) {\n            $.ajax({\n                url: M.cfg.wwwroot + '/local/jobboard/ajax/get_convocatorias.php',\n                method: 'GET',\n                data: params,\n                dataType: 'json'\n            }).done(function(response) {\n                if (response.success) {\n                    resolve(response.convocatorias);\n                } else {\n                    reject(response.error || 'Unknown error');\n                }\n            }).fail(function(jqXHR, textStatus, errorThrown) {\n                reject(textStatus + ': ' + errorThrown);\n            });\n        });\n    };\n\n    /**\n     * Populate a select element with convocatorias.\n     *\n     * @param {jQuery} selectElement The select element to populate.\n     * @param {Array} convocatorias Array of convocatoria objects.\n     * @param {number} preselect Optional convocatoria ID to preselect.\n     * @param {string} placeholder Placeholder text for empty option.\n     */\n    var populateSelect = function(selectElement, convocatorias, preselect, placeholder) {\n        selectElement.empty();\n\n        // Add placeholder option.\n        selectElement.append($('<option>', {\n            value: '',\n            text: placeholder || 'Seleccionar convocatoria...'\n        }));\n\n        // Add convocatoria options.\n        $.each(convocatorias, function(index, conv) {\n            var option = $('<option>', {\n                value: conv.id,\n                text: conv.label || (conv.code + ' - ' + conv.name)\n            });\n            // Add status as data attribute.\n            option.attr('data-status', conv.status);\n\n            if (preselect && parseInt(preselect, 10) === parseInt(conv.id, 10)) {\n                option.prop('selected', true);\n            }\n            selectElement.append(option);\n        });\n    };\n\n    /**\n     * Initialize convocatoria loader for a select element.\n     *\n     * @param {Object} options Configuration options.\n     * @param {string} options.convocatoriaSelector Selector for convocatoria element.\n     * @param {string} options.companySelector Optional selector for company element (for filtering).\n     * @param {number} options.preselect Optional convocatoria ID to preselect.\n     * @param {string} options.placeholder Placeholder text.\n     * @param {string} options.status Filter by status (e.g., 'open').\n     * @param {boolean} options.includeall Include all statuses.\n     * @param {boolean} options.enableSearch Enable search functionality.\n     */\n    var init = function(options) {\n        options = options || {};\n\n        var convSelect = $(options.convocatoriaSelector);\n        if (!convSelect.length) {\n            return;\n        }\n\n        var placeholder = options.placeholder || '';\n        var preselect = options.preselect || 0;\n\n        // Get placeholder from language string if not provided.\n        if (!placeholder) {\n            Str.get_string('selectconvocatoria', 'local_jobboard').done(function(str) {\n                placeholder = str;\n                loadInitialConvocatorias();\n            }).fail(function() {\n                placeholder = 'Seleccionar convocatoria...';\n                loadInitialConvocatorias();\n            });\n        } else {\n            loadInitialConvocatorias();\n        }\n\n        /**\n         * Load initial convocatorias.\n         */\n        function loadInitialConvocatorias() {\n            var params = {\n                includeall: options.includeall ? 1 : 0\n            };\n\n            if (options.status) {\n                params.status = options.status;\n            }\n\n            // If there's a company selector, get its value.\n            if (options.companySelector) {\n                var companySelect = $(options.companySelector);\n                if (companySelect.length && companySelect.val()) {\n                    params.companyid = companySelect.val();\n                }\n            }\n\n            loadConvocatorias(params).then(function(convocatorias) {\n                populateSelect(convSelect, convocatorias, preselect, placeholder);\n            }).catch(function(error) {\n                // eslint-disable-next-line no-console\n                console.error('Error loading convocatorias:', error);\n            });\n        }\n\n        // If there's a company selector, reload convocatorias when company changes.\n        if (options.companySelector) {\n            $(options.companySelector).on('change', function() {\n                var companyId = $(this).val();\n                var params = {\n                    includeall: options.includeall ? 1 : 0\n                };\n\n                if (options.status) {\n                    params.status = options.status;\n                }\n\n                if (companyId) {\n                    params.companyid = companyId;\n                }\n\n                loadConvocatorias(params).then(function(convocatorias) {\n                    populateSelect(convSelect, convocatorias, null, placeholder);\n                }).catch(function(error) {\n                    // eslint-disable-next-line no-console\n                    console.error('Error reloading convocatorias:', error);\n                });\n            });\n        }\n\n        // Enable search functionality if requested.\n        if (options.enableSearch) {\n            initSearchableSelect(convSelect, placeholder, options);\n        }\n    };\n\n    /**\n     * Initialize searchable select with autocomplete.\n     *\n     * @param {jQuery} selectElement The select element.\n     * @param {string} placeholder Placeholder text.\n     * @param {Object} options Original options.\n     */\n    var initSearchableSelect = function(selectElement, placeholder, options) {\n        // Create search wrapper.\n        var wrapper = $('<div>', {'class': 'jb-convocatoria-search-wrapper position-relative'});\n        var searchInput = $('<input>', {\n            'type': 'text',\n            'class': 'form-control jb-convocatoria-search',\n            'placeholder': placeholder,\n            'autocomplete': 'off'\n        });\n        var dropdown = $('<div>', {'class': 'jb-convocatoria-dropdown dropdown-menu w-100', 'style': 'display:none;'});\n\n        // Wrap the original select.\n        selectElement.wrap(wrapper);\n        selectElement.before(searchInput);\n        selectElement.after(dropdown);\n        selectElement.hide();\n\n        var searchTimeout = null;\n\n        // Handle search input.\n        searchInput.on('input', function() {\n            var searchTerm = $(this).val();\n\n            if (searchTimeout) {\n                clearTimeout(searchTimeout);\n            }\n\n            if (searchTerm.length < 2) {\n                dropdown.hide();\n                return;\n            }\n\n            searchTimeout = setTimeout(function() {\n                var params = {\n                    search: searchTerm,\n                    includeall: options.includeall ? 1 : 0\n                };\n\n                if (options.status) {\n                    params.status = options.status;\n                }\n\n                loadConvocatorias(params).then(function(convocatorias) {\n                    dropdown.empty();\n                    if (convocatorias.length === 0) {\n                        Str.get_string('noresults', 'local_jobboard').done(function(str) {\n                            dropdown.append($('<div>', {\n                                'class': 'dropdown-item text-muted',\n                                'text': str\n                            }));\n                        });\n                    } else {\n                        $.each(convocatorias, function(index, conv) {\n                            var statusClass = conv.status === 'open' ? 'text-success' : 'text-muted';\n                            var item = $('<a>', {\n                                'class': 'dropdown-item',\n                                'href': '#',\n                                'html': '<span class=\"font-weight-bold\">' + conv.code + '</span> - ' +\n                                        conv.name + ' <small class=\"' + statusClass + '\">(' + conv.status + ')</small>',\n                                'data-id': conv.id\n                            });\n                            item.on('click', function(e) {\n                                e.preventDefault();\n                                selectElement.val(conv.id).trigger('change');\n                                searchInput.val(conv.code + ' - ' + conv.name);\n                                dropdown.hide();\n                            });\n                            dropdown.append(item);\n                        });\n                    }\n                    dropdown.show();\n                }).catch(function(error) {\n                    // eslint-disable-next-line no-console\n                    console.error('Search error:', error);\n                });\n            }, 300);\n        });\n\n        // Hide dropdown on blur.\n        searchInput.on('blur', function() {\n            setTimeout(function() {\n                dropdown.hide();\n            }, 200);\n        });\n\n        // Show dropdown on focus if has value.\n        searchInput.on('focus', function() {\n            if ($(this).val().length >= 2) {\n                dropdown.show();\n            }\n        });\n\n        // Set initial value if preselected.\n        var selectedOption = selectElement.find('option:selected');\n        if (selectedOption.val() && selectedOption.val() !== '') {\n            searchInput.val(selectedOption.text());\n        }\n    };\n\n    /**\n     * Initialize for filter forms.\n     *\n     * @param {Object} options Configuration options.\n     */\n    var initFilter = function(options) {\n        options = options || {};\n\n        var convSelect = $(options.convocatoriaSelector || '#filter-convocatoria');\n\n        if (!convSelect.length) {\n            return;\n        }\n\n        var placeholder = options.allLabel || 'Todas las convocatorias';\n\n        // Load convocatorias.\n        var params = {\n            includeall: options.includeall ? 1 : 0\n        };\n\n        if (options.status) {\n            params.status = options.status;\n        }\n\n        loadConvocatorias(params).then(function(convocatorias) {\n            convSelect.empty();\n\n            // Add \"All\" option.\n            convSelect.append($('<option>', {\n                value: 0,\n                text: placeholder\n            }));\n\n            // Add convocatoria options.\n            $.each(convocatorias, function(index, conv) {\n                var option = $('<option>', {\n                    value: conv.id,\n                    text: conv.label || (conv.code + ' - ' + conv.name)\n                });\n                if (options.preselect && parseInt(options.preselect, 10) === parseInt(conv.id, 10)) {\n                    option.prop('selected', true);\n                }\n                convSelect.append(option);\n            });\n        }).catch(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Error loading convocatorias for filter:', error);\n        });\n    };\n\n    return {\n        init: init,\n        initFilter: initFilter,\n        loadConvocatorias: loadConvocatorias,\n        populateSelect: populateSelect\n    };\n});\n"],"names":["define","$","Str","loadConvocatorias","params","Promise","resolve","reject","ajax","url","M","cfg","wwwroot","method","data","dataType","done","response","success","convocatorias","error","fail","jqXHR","textStatus","errorThrown","populateSelect","selectElement","preselect","placeholder","empty","append","value","text","each","index","conv","option","id","label","code","name","attr","status","parseInt","prop","initSearchableSelect","options","wrapper","searchInput","dropdown","wrap","before","after","hide","searchTimeout","on","searchTerm","this","val","clearTimeout","length","setTimeout","search","includeall","then","get_string","str","statusClass","item","e","preventDefault","trigger","show","catch","console","selectedOption","find","init","convSelect","convocatoriaSelector","loadInitialConvocatorias","companySelector","companyId","companyid","enableSearch","companySelect","initFilter","allLabel"],"mappings":"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"}