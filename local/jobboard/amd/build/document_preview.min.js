/**
 * Document preview module for local_jobboard.
 *
 * Provides inline preview functionality for PDF and image documents
 * without requiring file download. Uses PDF.js for PDF rendering.
 *
 * @module     local_jobboard/document_preview
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/modal_factory","core/modal_events","core/str","core/notification"],(function(t,e,n,o,i){const a="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";const r="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";let c=false;let s=null;let l=1;let d=1;const u=function(){return new Promise((function(t,e){if(c&&window.pdfjsLib){t();return}const n=document.createElement("script");n.src=a;n.onload=function(){window.pdfjsLib.GlobalWorkerOptions.workerSrc=r;c=true;t()};n.onerror=function(){e(new Error("Failed to load PDF.js"))};document.head.appendChild(n)}))};const f=function(t,e,n){const o=t.getViewport({scale:n});const i=e.getContext("2d");e.height=o.height;e.width=o.width;return t.render({canvasContext:i,viewport:o}).promise};const p=function(t){if(!s){return}const e=t.querySelector(".preview-page-info");if(e){e.textContent=l+" / "+s.numPages}const n=t.querySelector('[data-action="prev-page"]');const o=t.querySelector('[data-action="next-page"]');if(n){n.disabled=l<=1}if(o){o.disabled=l>=s.numPages}};const m=function(t,e){if(!s||e<1||e>s.numPages){return Promise.resolve()}l=e;const n=t.querySelector(".preview-canvas");return s.getPage(e).then((function(t){return f(t,n,d)})).then((function(){p(t)}))};const v=function(t,e){const n=e==="application/pdf";const o=e.startsWith("image/");let i='<div class="document-preview-container">';i+='<div class="preview-toolbar d-flex justify-content-between align-items-center mb-2 p-2 bg-light">';i+='<div class="preview-filename text-truncate"><strong>'+t+"</strong></div>";i+='<div class="preview-controls">';if(n){i+='<button type="button" class="btn btn-sm btn-outline-secondary mr-1" '+'data-action="prev-page" title="Previous page"><i class="fa fa-chevron-left"></i></button>';i+='<span class="preview-page-info mx-2">1 / 1</span>';i+='<button type="button" class="btn btn-sm btn-outline-secondary mr-2" '+'data-action="next-page" title="Next page"><i class="fa fa-chevron-right"></i></button>'}i+='<button type="button" class="btn btn-sm btn-outline-secondary mr-1" '+'data-action="zoom-out" title="Zoom out"><i class="fa fa-search-minus"></i></button>';i+='<span class="preview-zoom-info mx-1">100%</span>';i+='<button type="button" class="btn btn-sm btn-outline-secondary mr-2" '+'data-action="zoom-in" title="Zoom in"><i class="fa fa-search-plus"></i></button>';i+='<button type="button" class="btn btn-sm btn-outline-secondary" '+'data-action="rotate" title="Rotate"><i class="fa fa-rotate-right"></i></button>';i+="</div>";i+="</div>";i+='<div class="preview-area text-center" style="max-height: 70vh; overflow: auto;">';if(n){i+='<canvas class="preview-canvas border"></canvas>'}else if(o){i+='<img class="preview-image img-fluid border" alt="'+t+'" '+'style="max-width: 100%; transition: transform 0.2s;">'}else{i+='<div class="alert alert-info">';i+="Preview not available for this file type. ";i+='<a href="#" class="download-link">Download to view</a>';i+="</div>"}i+="</div>";i+="</div>";return i};const b=function(t,e,n){const o=t.getRoot()[0];const i=n==="application/pdf";const a=n.startsWith("image/");let r=0;o.querySelector('[data-action="zoom-in"]').addEventListener("click",(function(){d=Math.min(d+.25,3);g(o,i,a)}));o.querySelector('[data-action="zoom-out"]').addEventListener("click",(function(){d=Math.max(d-.25,.5);g(o,i,a)}));o.querySelector('[data-action="rotate"]').addEventListener("click",(function(){r=(r+90)%360;const t=i?o.querySelector(".preview-canvas"):o.querySelector(".preview-image");if(t){t.style.transform="rotate("+r+"deg) scale("+d+")"}}));if(i){o.querySelector('[data-action="prev-page"]').addEventListener("click",(function(){m(o,l-1)}));o.querySelector('[data-action="next-page"]').addEventListener("click",(function(){m(o,l+1)}))}if(i){w(o,e)}else if(a){y(o,e)}const c=o.querySelector(".download-link");if(c){c.href=e;c.target="_blank"}};const g=function(t,e,n){const o=t.querySelector(".preview-zoom-info");if(o){o.textContent=Math.round(d*100)+"%"}if(e&&s){m(t,l)}else if(n){const e=t.querySelector(".preview-image");if(e){e.style.transform="scale("+d+")"}}};const w=function(t,e){const n=t.querySelector(".preview-canvas");n.style.display="none";const o=document.createElement("div");o.className="preview-loading text-center py-5";o.innerHTML='<i class="fa fa-spinner fa-spin fa-3x"></i><p class="mt-2">Loading PDF...</p>';n.parentNode.insertBefore(o,n);u().then((function(){return window.pdfjsLib.getDocument(e).promise})).then((function(e){s=e;l=1;o.remove();n.style.display="block";return m(t,1)})).catch((function(t){o.innerHTML='<div class="alert alert-danger">'+"Failed to load PDF: "+t.message+"</div>";console.error("PDF load error:",t)}))};const y=function(t,e){const n=t.querySelector(".preview-image");n.src=e;n.onerror=function(){n.parentNode.innerHTML='<div class="alert alert-danger">Failed to load image</div>'}};const h=function(t,a,r){s=null;l=1;d=1;o.get_string("previewdocument","local_jobboard").then((function(t){return e.create({type:e.types.DEFAULT,title:t,body:v(a,r),large:true})})).then((function(e){e.getRoot().on(n.hidden,(function(){e.destroy()}));e.show();b(e,t,r)})).catch(i.exception)};const x=function(){t(document).on("click","[data-preview-url]",(function(e){e.preventDefault();const n=t(this);const o=n.data("preview-url");const i=n.data("preview-filename")||"Document";const a=n.data("preview-mimetype")||"application/pdf";h(o,i,a)}))};return{init:x,openPreview:h}}));