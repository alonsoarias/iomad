/**
 * AMD module for dynamic company loading with autocomplete/search functionality.
 *
 * This module provides AJAX-based company selection for forms and filters.
 * It supports both autocomplete search and standard select dropdown modes.
 *
 * @module     local_jobboard/company_loader
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/str","local_jobboard/department_loader"],(function(e,t,n){"use strict";var o=function(t,n){return new Promise((function(o,a){var r={};t&&(r.search=t),n&&(r.id=n),e.ajax({url:M.cfg.wwwroot+"/local/jobboard/ajax/get_companies.php",method:"GET",data:r,dataType:"json"}).done((function(e){e.success?o(e.companies):a(e.error||"Unknown error")})).fail((function(e,t,n){a(t+": "+n)}))}))},a=function(t,n,o,a){t.empty(),t.append(e("<option>",{value:0,text:a||"Seleccionar..."})),e.each(n,(function(n,a){var r=e("<option>",{value:a.id,text:a.name});o&&parseInt(o,10)===parseInt(a.id,10)&&r.prop("selected",!0),t.append(r)}))},r=function(n,a){var r=e("<div>",{class:"jb-company-search-wrapper position-relative"}),c=e("<input>",{type:"text",class:"form-control jb-company-search",placeholder:a,autocomplete:"off"}),l=e("<div>",{class:"jb-company-dropdown dropdown-menu w-100",style:"display:none;"});n.wrap(r),n.before(c),n.after(l),n.hide();var i=null;c.on("input",(function(){var a=e(this).val();i&&clearTimeout(i),a.length<2?l.hide():i=setTimeout((function(){o(a).then((function(o){l.empty(),0===o.length?t.get_string("noresults","local_jobboard").done((function(t){l.append(e("<div>",{class:"dropdown-item text-muted",text:t}))})):e.each(o,(function(t,o){var a=e("<a>",{class:"dropdown-item",href:"#",text:o.name,"data-id":o.id});a.on("click",(function(e){e.preventDefault(),n.val(o.id).trigger("change"),c.val(o.name),l.hide()})),l.append(a)})),l.show()})).catch((function(e){console.error("Search error:",e)}))}),300)})),c.on("blur",(function(){setTimeout((function(){l.hide()}),200)})),c.on("focus",(function(){e(this).val().length>=2&&l.show()}));var p=n.find("option:selected");p.val()&&"0"!==p.val()&&c.val(p.text())};return{init:function(c){var l=e((c=c||{}).companySelector);if(l.length){var i=c.placeholder||"",p=c.preselect||0;i||t.get_string("selectcompany","local_jobboard").done((function(e){i=e})),o().then((function(t){if(a(l,t,p,i),p&&c.departmentSelector){var o=e(c.departmentSelector);o.length&&n.loadDepartments(o,p,c.departmentPreselect)}})).catch((function(e){console.error("Error loading companies:",e)})),c.departmentSelector&&l.on("change",(function(){var t=e(this).val(),o=e(c.departmentSelector);o.length&&n.loadDepartments(o,t)})),c.enableSearch&&r(l,i)}},initFilter:function(t){var o=e((t=t||{}).companySelector||"#filter-companyid"),a=e(t.departmentSelector||"#filter-departmentid");if(o.length){o.on("change",(function(){var o=e(this).val();a.length&&n.loadDepartments(a,o,null,t.allDepartmentsLabel)}));var r=o.val();r&&"0"!==r&&n.loadDepartments(a,r,t.departmentPreselect,t.allDepartmentsLabel)}},loadCompanies:o,populateSelect:a}}));
//# sourceMappingURL=company_loader.min.js.map