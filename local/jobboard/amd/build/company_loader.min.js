/**
 * AMD module for dynamic company loading with autocomplete/search functionality.
 *
 * This module provides AJAX-based company selection for forms and filters.
 * It supports both autocomplete search and standard select dropdown modes.
 *
 * @module     local_jobboard/company_loader
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_jobboard/company_loader",["jquery","core/str","local_jobboard/department_loader"],(function($,Str,DepartmentLoader){var loadCompanies=function(search,companyId){return new Promise((function(resolve,reject){var data={};search&&(data.search=search),companyId&&(data.id=companyId),$.ajax({url:M.cfg.wwwroot+"/local/jobboard/ajax/get_companies.php",method:"GET",data:data,dataType:"json"}).done((function(response){response.success?resolve(response.companies):reject(response.error||"Unknown error")})).fail((function(jqXHR,textStatus,errorThrown){reject(textStatus+": "+errorThrown)}))}))},populateSelect=function(selectElement,companies,preselect,placeholder){selectElement.empty(),selectElement.append($("<option>",{value:0,text:placeholder||"Seleccionar..."})),$.each(companies,(function(index,company){var option=$("<option>",{value:company.id,text:company.name});preselect&&parseInt(preselect,10)===parseInt(company.id,10)&&option.prop("selected",!0),selectElement.append(option)}))},initSearchableSelect=function(selectElement,placeholder){var wrapper=$("<div>",{class:"jb-company-search-wrapper position-relative"}),searchInput=$("<input>",{type:"text",class:"form-control jb-company-search",placeholder:placeholder,autocomplete:"off"}),dropdown=$("<div>",{class:"jb-company-dropdown dropdown-menu w-100",style:"display:none;"});selectElement.wrap(wrapper),selectElement.before(searchInput),selectElement.after(dropdown),selectElement.hide();var searchTimeout=null;searchInput.on("input",(function(){var searchTerm=$(this).val();searchTimeout&&clearTimeout(searchTimeout),searchTerm.length<2?dropdown.hide():searchTimeout=setTimeout((function(){loadCompanies(searchTerm).then((function(companies){dropdown.empty(),0===companies.length?Str.get_string("noresults","local_jobboard").done((function(str){dropdown.append($("<div>",{class:"dropdown-item text-muted",text:str}))})):$.each(companies,(function(index,company){var item=$("<a>",{class:"dropdown-item",href:"#",text:company.name,"data-id":company.id});item.on("click",(function(e){e.preventDefault(),selectElement.val(company.id).trigger("change"),searchInput.val(company.name),dropdown.hide()})),dropdown.append(item)})),dropdown.show()})).catch((function(error){console.error("Search error:",error)}))}),300)})),searchInput.on("blur",(function(){setTimeout((function(){dropdown.hide()}),200)})),searchInput.on("focus",(function(){$(this).val().length>=2&&dropdown.show()}));var selectedOption=selectElement.find("option:selected");selectedOption.val()&&"0"!==selectedOption.val()&&searchInput.val(selectedOption.text())};return{init:function(options){var companySelect=$((options=options||{}).companySelector);if(companySelect.length){var placeholder=options.placeholder||"",preselect=options.preselect||0;placeholder||Str.get_string("selectcompany","local_jobboard").done((function(str){placeholder=str})),loadCompanies().then((function(companies){if(populateSelect(companySelect,companies,preselect,placeholder),preselect&&options.departmentSelector){var deptSelect=$(options.departmentSelector);deptSelect.length&&DepartmentLoader.loadDepartments(deptSelect,preselect,options.departmentPreselect)}})).catch((function(error){console.error("Error loading companies:",error)})),options.departmentSelector&&companySelect.on("change",(function(){var companyId=$(this).val(),deptSelect=$(options.departmentSelector);deptSelect.length&&DepartmentLoader.loadDepartments(deptSelect,companyId)})),options.enableSearch&&initSearchableSelect(companySelect,placeholder)}},initFilter:function(options){var companySelect=$((options=options||{}).companySelector||"#filter-companyid"),departmentSelect=$(options.departmentSelector||"#filter-departmentid");if(companySelect.length){companySelect.on("change",(function(){var companyId=$(this).val();departmentSelect.length&&DepartmentLoader.loadDepartments(departmentSelect,companyId,null,options.allDepartmentsLabel)}));var initialCompany=companySelect.val();initialCompany&&"0"!==initialCompany&&DepartmentLoader.loadDepartments(departmentSelect,initialCompany,options.departmentPreselect,options.allDepartmentsLabel)}},loadCompanies:loadCompanies,populateSelect:populateSelect}}));

//# sourceMappingURL=company_loader.min.js.map