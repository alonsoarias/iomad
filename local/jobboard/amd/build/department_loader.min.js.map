{"version":3,"file":"department_loader.min.js","sources":["../src/department_loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for dynamic department loading based on company selection.\n *\n * This unified module can be used across all forms that have company/department selectors.\n * It uses the AJAX endpoint which works for both authenticated and guest users.\n *\n * @module     local_jobboard/department_loader\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str'], function($, Str) {\n    'use strict';\n\n    /**\n     * Load departments for a given company.\n     *\n     * @param {jQuery} departmentSelect The department select element.\n     * @param {number} companyId The company ID.\n     * @param {number} preselect Optional department ID to preselect.\n     */\n    var loadDepartments = function(departmentSelect, companyId, preselect) {\n        // Clear current options.\n        departmentSelect.empty();\n\n        if (!companyId || companyId === '0' || companyId === 0) {\n            // No company selected, add placeholder.\n            Str.get_string('selectdepartment', 'local_jobboard').done(function(str) {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: str\n                }));\n            }).fail(function() {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: 'Seleccionar modalidad...'\n                }));\n            });\n            return;\n        }\n\n        // Show loading state.\n        departmentSelect.prop('disabled', true);\n        Str.get_string('loading', 'local_jobboard').done(function(str) {\n            departmentSelect.append($('<option>', {\n                value: 0,\n                text: str + '...'\n            }));\n        }).fail(function() {\n            departmentSelect.append($('<option>', {\n                value: 0,\n                text: 'Cargando...'\n            }));\n        });\n\n        // Fetch departments via AJAX endpoint.\n        $.ajax({\n            url: M.cfg.wwwroot + '/local/jobboard/ajax/get_departments.php',\n            method: 'GET',\n            data: {\n                companyid: parseInt(companyId, 10)\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            departmentSelect.empty();\n            departmentSelect.prop('disabled', false);\n\n            // Add placeholder option.\n            Str.get_string('selectdepartment', 'local_jobboard').done(function(str) {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: str\n                }));\n\n                // Add department options.\n                if (response.success && response.departments && response.departments.length > 0) {\n                    $.each(response.departments, function(index, dept) {\n                        var option = $('<option>', {\n                            value: dept.id,\n                            text: dept.name\n                        });\n                        // Preselect if specified.\n                        if (preselect && parseInt(preselect, 10) === parseInt(dept.id, 10)) {\n                            option.prop('selected', true);\n                        }\n                        departmentSelect.append(option);\n                    });\n                }\n            }).fail(function() {\n                // Fallback if string not found.\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: 'Seleccionar modalidad...'\n                }));\n\n                if (response.success && response.departments && response.departments.length > 0) {\n                    $.each(response.departments, function(index, dept) {\n                        var option = $('<option>', {\n                            value: dept.id,\n                            text: dept.name\n                        });\n                        if (preselect && parseInt(preselect, 10) === parseInt(dept.id, 10)) {\n                            option.prop('selected', true);\n                        }\n                        departmentSelect.append(option);\n                    });\n                }\n            });\n\n        }).fail(function(jqXHR, textStatus, errorThrown) {\n            departmentSelect.empty();\n            departmentSelect.prop('disabled', false);\n            Str.get_string('selectdepartment', 'local_jobboard').done(function(str) {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: str\n                }));\n            }).fail(function() {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: 'Seleccionar modalidad...'\n                }));\n            });\n            // eslint-disable-next-line no-console\n            console.error('Error loading departments:', textStatus, errorThrown);\n        });\n    };\n\n    /**\n     * Find elements using multiple selector strategies.\n     *\n     * @param {string} baseName The base name of the element (e.g., 'companyid').\n     * @param {string} context Optional context selector to narrow search.\n     * @return {jQuery} The found element or empty jQuery object.\n     */\n    var findElement = function(baseName, context) {\n        var selectors = [\n            'select[name=\"' + baseName + '\"]',\n            '#id_' + baseName,\n            '#id_' + baseName + '_signup',\n            '[id$=\"_' + baseName + '\"]'\n        ];\n\n        var $context = context ? $(context) : $(document);\n\n        for (var i = 0; i < selectors.length; i++) {\n            var $el = $context.find(selectors[i]);\n            if ($el.length) {\n                return $el.first();\n            }\n        }\n\n        // Also try without context.\n        for (var j = 0; j < selectors.length; j++) {\n            var $elem = $(selectors[j]);\n            if ($elem.length) {\n                return $elem.first();\n            }\n        }\n\n        return $();\n    };\n\n    /**\n     * Initialize department loading for a form.\n     *\n     * @param {Object} options Configuration options.\n     * @param {string} options.companySelector Selector for company element.\n     * @param {string} options.departmentSelector Selector for department element.\n     * @param {string} options.formContext Optional form context selector.\n     * @param {number} options.preselect Optional department ID to preselect.\n     */\n    var init = function(options) {\n        options = options || {};\n\n        var companySelect, departmentSelect;\n\n        // Find company select.\n        if (options.companySelector) {\n            companySelect = $(options.companySelector);\n        } else {\n            companySelect = findElement('companyid', options.formContext);\n        }\n\n        // Find department select.\n        if (options.departmentSelector) {\n            departmentSelect = $(options.departmentSelector);\n        } else {\n            departmentSelect = findElement('departmentid', options.formContext);\n        }\n\n        // Exit if elements not found.\n        if (!companySelect.length || !departmentSelect.length) {\n            // eslint-disable-next-line no-console\n            console.log('JobBoard department_loader: Company or department selects not found');\n            return;\n        }\n\n        // eslint-disable-next-line no-console\n        console.log('JobBoard department_loader: Initialized with',\n            companySelect.attr('id') || companySelect.attr('name'),\n            departmentSelect.attr('id') || departmentSelect.attr('name'));\n\n        // Handle company change.\n        companySelect.on('change', function() {\n            var companyId = $(this).val();\n            loadDepartments(departmentSelect, companyId);\n        });\n\n        // Load departments if company is pre-selected.\n        var initialCompany = companySelect.val();\n        if (initialCompany && initialCompany !== '0' && initialCompany !== 0) {\n            loadDepartments(departmentSelect, initialCompany, options.preselect);\n        }\n    };\n\n    return {\n        init: init,\n        loadDepartments: loadDepartments,\n        findElement: findElement\n    };\n});\n"],"names":["define","$","Str","loadDepartments","departmentSelect","companyId","preselect","empty","prop","get_string","done","str","append","value","text","fail","ajax","url","M","cfg","wwwroot","method","data","companyid","parseInt","dataType","response","success","departments","length","each","index","dept","option","id","name","jqXHR","textStatus","errorThrown","console","error","findElement","baseName","context","selectors","$context","document","i","$el","find","first","j","$elem","init","options","companySelect","companySelector","formContext","departmentSelector","log","attr","on","this","val","initialCompany"],"mappings":"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"}