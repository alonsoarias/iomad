{"version":3,"file":"department_loader.min.js","sources":["../src/department_loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for dynamic department loading based on company selection.\n *\n * This unified module can be used across all forms that have company/department selectors.\n * It uses the AJAX endpoint which works for both authenticated and guest users.\n *\n * @module     local_jobboard/department_loader\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str'], function($, Str) {\n    'use strict';\n\n    /**\n     * Load departments for a given company.\n     *\n     * @param {jQuery} departmentSelect The department select element.\n     * @param {number} companyId The company ID.\n     * @param {number} preselect Optional department ID to preselect.\n     * @param {string} allLabel Optional label for \"All\" option (used in filters).\n     */\n    var loadDepartments = function(departmentSelect, companyId, preselect, allLabel) {\n        // Clear current options.\n        departmentSelect.empty();\n\n        // Determine the placeholder text.\n        var placeholderKey = allLabel ? null : 'selectdepartment';\n        var placeholderText = allLabel || 'Seleccionar modalidad...';\n\n        if (!companyId || companyId === '0' || companyId === 0) {\n            // No company selected, add placeholder.\n            if (placeholderKey) {\n                Str.get_string(placeholderKey, 'local_jobboard').done(function(str) {\n                    departmentSelect.append($('<option>', {\n                        value: 0,\n                        text: str\n                    }));\n                }).fail(function() {\n                    departmentSelect.append($('<option>', {\n                        value: 0,\n                        text: placeholderText\n                    }));\n                });\n            } else {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: placeholderText\n                }));\n            }\n            return;\n        }\n\n        // Show loading state.\n        departmentSelect.prop('disabled', true);\n        Str.get_string('loading', 'local_jobboard').done(function(str) {\n            departmentSelect.append($('<option>', {\n                value: 0,\n                text: str + '...'\n            }));\n        }).fail(function() {\n            departmentSelect.append($('<option>', {\n                value: 0,\n                text: 'Cargando...'\n            }));\n        });\n\n        // Fetch departments via AJAX endpoint.\n        $.ajax({\n            url: M.cfg.wwwroot + '/local/jobboard/ajax/get_departments.php',\n            method: 'GET',\n            data: {\n                companyid: parseInt(companyId, 10)\n            },\n            dataType: 'json'\n        }).done(function(response) {\n            departmentSelect.empty();\n            departmentSelect.prop('disabled', false);\n\n            // Determine placeholder text (use default first, then update async if needed).\n            var defaultPlaceholder = allLabel || 'Seleccionar modalidad...';\n\n            // Add placeholder option immediately.\n            var placeholderOption = $('<option>', {\n                value: 0,\n                text: defaultPlaceholder\n            });\n            departmentSelect.append(placeholderOption);\n\n            // Add department options.\n            if (response.success && response.departments && response.departments.length > 0) {\n                $.each(response.departments, function(index, dept) {\n                    var option = $('<option>', {\n                        value: dept.id,\n                        text: dept.name\n                    });\n                    // Preselect if specified.\n                    if (preselect && parseInt(preselect, 10) === parseInt(dept.id, 10)) {\n                        option.prop('selected', true);\n                    }\n                    departmentSelect.append(option);\n                });\n            }\n\n            // Update placeholder text asynchronously (doesn't block options).\n            if (!allLabel) {\n                Str.get_string('selectdepartment', 'local_jobboard').done(function(str) {\n                    placeholderOption.text(str);\n                });\n            }\n\n        }).fail(function(jqXHR, textStatus, errorThrown) {\n            departmentSelect.empty();\n            departmentSelect.prop('disabled', false);\n\n            if (allLabel) {\n                departmentSelect.append($('<option>', {\n                    value: 0,\n                    text: allLabel\n                }));\n            } else {\n                Str.get_string('selectdepartment', 'local_jobboard').done(function(str) {\n                    departmentSelect.append($('<option>', {\n                        value: 0,\n                        text: str\n                    }));\n                }).fail(function() {\n                    departmentSelect.append($('<option>', {\n                        value: 0,\n                        text: placeholderText\n                    }));\n                });\n            }\n            // eslint-disable-next-line no-console\n            console.error('Error loading departments:', textStatus, errorThrown);\n        });\n    };\n\n    /**\n     * Find elements using multiple selector strategies.\n     *\n     * @param {string} baseName The base name of the element (e.g., 'companyid').\n     * @param {string} context Optional context selector to narrow search.\n     * @return {jQuery} The found element or empty jQuery object.\n     */\n    var findElement = function(baseName, context) {\n        var selectors = [\n            'select[name=\"' + baseName + '\"]',\n            '#id_' + baseName,\n            '#id_' + baseName + '_signup',\n            '[id$=\"_' + baseName + '\"]'\n        ];\n\n        var $context = context ? $(context) : $(document);\n\n        for (var i = 0; i < selectors.length; i++) {\n            var $el = $context.find(selectors[i]);\n            if ($el.length) {\n                return $el.first();\n            }\n        }\n\n        // Also try without context.\n        for (var j = 0; j < selectors.length; j++) {\n            var $elem = $(selectors[j]);\n            if ($elem.length) {\n                return $elem.first();\n            }\n        }\n\n        return $();\n    };\n\n    /**\n     * Initialize department loading for a form.\n     *\n     * @param {Object} options Configuration options.\n     * @param {string} options.companySelector Selector for company element.\n     * @param {string} options.departmentSelector Selector for department element.\n     * @param {string} options.formContext Optional form context selector.\n     * @param {number} options.preselect Optional department ID to preselect.\n     */\n    var init = function(options) {\n        options = options || {};\n\n        var companySelect, departmentSelect;\n\n        // Find company select.\n        if (options.companySelector) {\n            companySelect = $(options.companySelector);\n        } else {\n            companySelect = findElement('companyid', options.formContext);\n        }\n\n        // Find department select.\n        if (options.departmentSelector) {\n            departmentSelect = $(options.departmentSelector);\n        } else {\n            departmentSelect = findElement('departmentid', options.formContext);\n        }\n\n        // Exit if elements not found.\n        if (!companySelect.length || !departmentSelect.length) {\n            // eslint-disable-next-line no-console\n            console.log('JobBoard department_loader: Company or department selects not found');\n            return;\n        }\n\n        // eslint-disable-next-line no-console\n        console.log('JobBoard department_loader: Initialized with',\n            companySelect.attr('id') || companySelect.attr('name'),\n            departmentSelect.attr('id') || departmentSelect.attr('name'));\n\n        // Handle company change.\n        companySelect.on('change', function() {\n            var companyId = $(this).val();\n            loadDepartments(departmentSelect, companyId);\n        });\n\n        // Load departments if company is pre-selected.\n        var initialCompany = companySelect.val();\n        if (initialCompany && initialCompany !== '0' && initialCompany !== 0) {\n            loadDepartments(departmentSelect, initialCompany, options.preselect);\n        }\n    };\n\n    return {\n        init: init,\n        loadDepartments: loadDepartments,\n        findElement: findElement\n    };\n});\n"],"names":["define","$","Str","loadDepartments","departmentSelect","companyId","preselect","allLabel","empty","placeholderKey","placeholderText","prop","get_string","done","str","append","value","text","fail","ajax","url","M","cfg","wwwroot","method","data","companyid","parseInt","dataType","response","placeholderOption","success","departments","length","each","index","dept","option","id","name","jqXHR","textStatus","errorThrown","console","error","findElement","baseName","context","selectors","$context","document","i","$el","find","first","j","$elem","init","options","companySelect","companySelector","formContext","departmentSelector","log","attr","on","this","val","initialCompany"],"mappings":"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"}