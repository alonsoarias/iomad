/**
 * AMD module for dynamic convocatoria loading with autocomplete/search functionality.
 *
 * This module provides AJAX-based convocatoria selection for forms and filters.
 *
 * @module     local_jobboard/convocatoria_loader
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_jobboard/convocatoria_loader",["jquery","core/str"],(function($,Str){var loadConvocatorias=function(params){return params=params||{},new Promise((function(resolve,reject){$.ajax({url:M.cfg.wwwroot+"/local/jobboard/ajax/get_convocatorias.php",method:"GET",data:params,dataType:"json"}).done((function(response){response.success?resolve(response.convocatorias):reject(response.error||"Unknown error")})).fail((function(jqXHR,textStatus,errorThrown){reject(textStatus+": "+errorThrown)}))}))},populateSelect=function(selectElement,convocatorias,preselect,placeholder){selectElement.empty(),selectElement.append($("<option>",{value:"",text:placeholder||"Seleccionar convocatoria..."})),$.each(convocatorias,(function(index,conv){var option=$("<option>",{value:conv.id,text:conv.label||conv.code+" - "+conv.name});option.attr("data-status",conv.status),preselect&&parseInt(preselect,10)===parseInt(conv.id,10)&&option.prop("selected",!0),selectElement.append(option)}))},initSearchableSelect=function(selectElement,placeholder,options){var wrapper=$("<div>",{class:"jb-convocatoria-search-wrapper position-relative"}),searchInput=$("<input>",{type:"text",class:"form-control jb-convocatoria-search",placeholder:placeholder,autocomplete:"off"}),dropdown=$("<div>",{class:"jb-convocatoria-dropdown dropdown-menu w-100",style:"display:none;"});selectElement.wrap(wrapper),selectElement.before(searchInput),selectElement.after(dropdown),selectElement.hide();var searchTimeout=null;searchInput.on("input",(function(){var searchTerm=$(this).val();searchTimeout&&clearTimeout(searchTimeout),searchTerm.length<2?dropdown.hide():searchTimeout=setTimeout((function(){var params={search:searchTerm,includeall:options.includeall?1:0};options.status&&(params.status=options.status),loadConvocatorias(params).then((function(convocatorias){dropdown.empty(),0===convocatorias.length?Str.get_string("noresults","local_jobboard").done((function(str){dropdown.append($("<div>",{class:"dropdown-item text-muted",text:str}))})):$.each(convocatorias,(function(index,conv){var statusClass="open"===conv.status?"text-success":"text-muted",item=$("<a>",{class:"dropdown-item",href:"#",html:'<span class="font-weight-bold">'+conv.code+"</span> - "+conv.name+' <small class="'+statusClass+'">('+conv.status+")</small>","data-id":conv.id});item.on("click",(function(e){e.preventDefault(),selectElement.val(conv.id).trigger("change"),searchInput.val(conv.code+" - "+conv.name),dropdown.hide()})),dropdown.append(item)})),dropdown.show()})).catch((function(error){console.error("Search error:",error)}))}),300)})),searchInput.on("blur",(function(){setTimeout((function(){dropdown.hide()}),200)})),searchInput.on("focus",(function(){$(this).val().length>=2&&dropdown.show()}));var selectedOption=selectElement.find("option:selected");selectedOption.val()&&""!==selectedOption.val()&&searchInput.val(selectedOption.text())};return{init:function(options){var convSelect=$((options=options||{}).convocatoriaSelector);if(convSelect.length){var placeholder=options.placeholder||"",preselect=options.preselect||0;placeholder?loadInitialConvocatorias():Str.get_string("selectconvocatoria","local_jobboard").done((function(str){placeholder=str,loadInitialConvocatorias()})).fail((function(){placeholder="Seleccionar convocatoria...",loadInitialConvocatorias()})),options.companySelector&&$(options.companySelector).on("change",(function(){var companyId=$(this).val(),params={includeall:options.includeall?1:0};options.status&&(params.status=options.status),companyId&&(params.companyid=companyId),loadConvocatorias(params).then((function(convocatorias){populateSelect(convSelect,convocatorias,null,placeholder)})).catch((function(error){console.error("Error reloading convocatorias:",error)}))})),options.enableSearch&&initSearchableSelect(convSelect,placeholder,options)}function loadInitialConvocatorias(){var params={includeall:options.includeall?1:0};if(options.status&&(params.status=options.status),options.companySelector){var companySelect=$(options.companySelector);companySelect.length&&companySelect.val()&&(params.companyid=companySelect.val())}loadConvocatorias(params).then((function(convocatorias){populateSelect(convSelect,convocatorias,preselect,placeholder)})).catch((function(error){console.error("Error loading convocatorias:",error)}))}},initFilter:function(options){var convSelect=$((options=options||{}).convocatoriaSelector||"#filter-convocatoria");if(convSelect.length){var placeholder=options.allLabel||"Todas las convocatorias",params={includeall:options.includeall?1:0};options.status&&(params.status=options.status),loadConvocatorias(params).then((function(convocatorias){convSelect.empty(),convSelect.append($("<option>",{value:0,text:placeholder})),$.each(convocatorias,(function(index,conv){var option=$("<option>",{value:conv.id,text:conv.label||conv.code+" - "+conv.name});options.preselect&&parseInt(options.preselect,10)===parseInt(conv.id,10)&&option.prop("selected",!0),convSelect.append(option)}))})).catch((function(error){console.error("Error loading convocatorias for filter:",error)}))}},loadConvocatorias:loadConvocatorias,populateSelect:populateSelect}}));

//# sourceMappingURL=convocatoria_loader.min.js.map