/**
 * AMD module for dynamic convocatoria loading with autocomplete/search functionality.
 *
 * This module provides AJAX-based convocatoria selection for forms and filters.
 *
 * @module     local_jobboard/convocatoria_loader
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/str"],(function(t,o){"use strict";var e=function(o){return o=o||{},new Promise((function(e,a){t.ajax({url:M.cfg.wwwroot+"/local/jobboard/ajax/get_convocatorias.php",method:"GET",data:o,dataType:"json"}).done((function(t){t.success?e(t.convocatorias):a(t.error||"Unknown error")})).fail((function(t,o,e){a(o+": "+e)}))}))},a=function(o,e,a,n){o.empty(),o.append(t("<option>",{value:"",text:n||"Seleccionar convocatoria..."})),t.each(e,(function(e,n){var c=t("<option>",{value:n.id,text:n.label||n.code+" - "+n.name});c.attr("data-status",n.status),a&&parseInt(a,10)===parseInt(n.id,10)&&c.prop("selected",!0),o.append(c)}))},n=function(a,n,c){var r=t("<div>",{class:"jb-convocatoria-search-wrapper position-relative"}),l=t("<input>",{type:"text",class:"form-control jb-convocatoria-search",placeholder:n,autocomplete:"off"}),i=t("<div>",{class:"jb-convocatoria-dropdown dropdown-menu w-100",style:"display:none;"});a.wrap(r),a.before(l),a.after(i),a.hide();var s=null;l.on("input",(function(){var n=t(this).val();s&&clearTimeout(s),n.length<2?i.hide():s=setTimeout((function(){var r={search:n,includeall:c.includeall?1:0};c.status&&(r.status=c.status),e(r).then((function(e){i.empty(),0===e.length?o.get_string("noresults","local_jobboard").done((function(o){i.append(t("<div>",{class:"dropdown-item text-muted",text:o}))})):t.each(e,(function(o,e){var n="open"===e.status?"text-success":"text-muted",c=t("<a>",{class:"dropdown-item",href:"#",html:'<span class="font-weight-bold">'+e.code+"</span> - "+e.name+' <small class="'+n+'">('+e.status+")</small>","data-id":e.id});c.on("click",(function(t){t.preventDefault(),a.val(e.id).trigger("change"),l.val(e.code+" - "+e.name),i.hide()})),i.append(c)})),i.show()})).catch((function(t){console.error("Search error:",t)}))}),300)})),l.on("blur",(function(){setTimeout((function(){i.hide()}),200)})),l.on("focus",(function(){t(this).val().length>=2&&i.show()}));var u=a.find("option:selected");u.val()&&""!==u.val()&&l.val(u.text())};return{init:function(c){var r=t((c=c||{}).convocatoriaSelector);if(r.length){var l=c.placeholder||"",i=c.preselect||0;l?s():o.get_string("selectconvocatoria","local_jobboard").done((function(t){l=t,s()})).fail((function(){l="Seleccionar convocatoria...",s()})),c.companySelector&&t(c.companySelector).on("change",(function(){var o=t(this).val(),n={includeall:c.includeall?1:0};c.status&&(n.status=c.status),o&&(n.companyid=o),e(n).then((function(t){a(r,t,null,l)})).catch((function(t){console.error("Error reloading convocatorias:",t)}))})),c.enableSearch&&n(r,l,c)}function s(){var o={includeall:c.includeall?1:0};if(c.status&&(o.status=c.status),c.companySelector){var n=t(c.companySelector);n.length&&n.val()&&(o.companyid=n.val())}e(o).then((function(t){a(r,t,i,l)})).catch((function(t){console.error("Error loading convocatorias:",t)}))}},initFilter:function(o){var a=t((o=o||{}).convocatoriaSelector||"#filter-convocatoria");if(a.length){var n=o.allLabel||"Todas las convocatorias",c={includeall:o.includeall?1:0};o.status&&(c.status=o.status),e(c).then((function(e){a.empty(),a.append(t("<option>",{value:0,text:n})),t.each(e,(function(e,n){var c=t("<option>",{value:n.id,text:n.label||n.code+" - "+n.name});o.preselect&&parseInt(o.preselect,10)===parseInt(n.id,10)&&c.prop("selected",!0),a.append(c)}))})).catch((function(t){console.error("Error loading convocatorias for filter:",t)}))}},loadConvocatorias:e,populateSelect:a}}));
//# sourceMappingURL=convocatoria_loader.min.js.map