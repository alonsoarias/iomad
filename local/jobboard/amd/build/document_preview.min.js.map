{"version":3,"file":"document_preview.min.js","sources":["../src/document_preview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Document preview module for local_jobboard.\n *\n * Provides inline preview functionality for PDF and image documents\n * without requiring file download. Uses PDF.js for PDF rendering.\n *\n * @module     local_jobboard/document_preview\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/str', 'core/notification'],\n    function($, ModalFactory, ModalEvents, Str, Notification) {\n\n    /**\n     * PDF.js library URL (bundled with Moodle or CDN fallback).\n     * @type {string}\n     */\n    const PDFJS_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';\n    const PDFJS_WORKER_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';\n\n    /**\n     * Track if PDF.js is loaded.\n     * @type {boolean}\n     */\n    let pdfjsLoaded = false;\n\n    /**\n     * Current PDF document.\n     * @type {Object|null}\n     */\n    let currentPdf = null;\n\n    /**\n     * Current page number.\n     * @type {number}\n     */\n    let currentPage = 1;\n\n    /**\n     * Current zoom level.\n     * @type {number}\n     */\n    let currentZoom = 1.0;\n\n    /**\n     * Load PDF.js library dynamically.\n     *\n     * @return {Promise} Resolves when PDF.js is loaded.\n     */\n    const loadPdfJs = function() {\n        return new Promise(function(resolve, reject) {\n            if (pdfjsLoaded && window.pdfjsLib) {\n                resolve();\n                return;\n            }\n\n            const script = document.createElement('script');\n            script.src = PDFJS_URL;\n            script.onload = function() {\n                window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_URL;\n                pdfjsLoaded = true;\n                resolve();\n            };\n            script.onerror = function() {\n                reject(new Error('Failed to load PDF.js'));\n            };\n            document.head.appendChild(script);\n        });\n    };\n\n    /**\n     * Render a PDF page to canvas.\n     *\n     * @param {Object} page PDF page object.\n     * @param {HTMLCanvasElement} canvas Canvas element.\n     * @param {number} zoom Zoom level.\n     * @return {Promise} Resolves when rendering is complete.\n     */\n    const renderPage = function(page, canvas, zoom) {\n        const viewport = page.getViewport({scale: zoom});\n        const context = canvas.getContext('2d');\n\n        canvas.height = viewport.height;\n        canvas.width = viewport.width;\n\n        return page.render({\n            canvasContext: context,\n            viewport: viewport\n        }).promise;\n    };\n\n    /**\n     * Update the page display.\n     *\n     * @param {HTMLElement} container Preview container.\n     */\n    const updatePageDisplay = function(container) {\n        if (!currentPdf) {\n            return;\n        }\n\n        const pageInfo = container.querySelector('.preview-page-info');\n        if (pageInfo) {\n            pageInfo.textContent = currentPage + ' / ' + currentPdf.numPages;\n        }\n\n        // Update button states.\n        const prevBtn = container.querySelector('[data-action=\"prev-page\"]');\n        const nextBtn = container.querySelector('[data-action=\"next-page\"]');\n        if (prevBtn) {\n            prevBtn.disabled = currentPage <= 1;\n        }\n        if (nextBtn) {\n            nextBtn.disabled = currentPage >= currentPdf.numPages;\n        }\n    };\n\n    /**\n     * Display a specific page of the PDF.\n     *\n     * @param {HTMLElement} container Preview container.\n     * @param {number} pageNum Page number to display.\n     * @return {Promise} Resolves when page is displayed.\n     */\n    const displayPage = function(container, pageNum) {\n        if (!currentPdf || pageNum < 1 || pageNum > currentPdf.numPages) {\n            return Promise.resolve();\n        }\n\n        currentPage = pageNum;\n        const canvas = container.querySelector('.preview-canvas');\n\n        return currentPdf.getPage(pageNum).then(function(page) {\n            return renderPage(page, canvas, currentZoom);\n        }).then(function() {\n            updatePageDisplay(container);\n        });\n    };\n\n    /**\n     * Create the preview modal content.\n     *\n     * @param {string} filename Document filename.\n     * @param {string} mimetype Document MIME type.\n     * @return {string} HTML content.\n     */\n    const createPreviewContent = function(filename, mimetype) {\n        const isPdf = mimetype === 'application/pdf';\n        const isImage = mimetype.startsWith('image/');\n\n        let content = '<div class=\"document-preview-container\">';\n\n        // Toolbar.\n        content += '<div class=\"preview-toolbar d-flex justify-content-between align-items-center mb-2 p-2 bg-light\">';\n        content += '<div class=\"preview-filename text-truncate\"><strong>' + filename + '</strong></div>';\n        content += '<div class=\"preview-controls\">';\n\n        if (isPdf) {\n            content += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary mr-1\" ' +\n                'data-action=\"prev-page\" title=\"Previous page\"><i class=\"fa fa-chevron-left\"></i></button>';\n            content += '<span class=\"preview-page-info mx-2\">1 / 1</span>';\n            content += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary mr-2\" ' +\n                'data-action=\"next-page\" title=\"Next page\"><i class=\"fa fa-chevron-right\"></i></button>';\n        }\n\n        content += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary mr-1\" ' +\n            'data-action=\"zoom-out\" title=\"Zoom out\"><i class=\"fa fa-search-minus\"></i></button>';\n        content += '<span class=\"preview-zoom-info mx-1\">100%</span>';\n        content += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary mr-2\" ' +\n            'data-action=\"zoom-in\" title=\"Zoom in\"><i class=\"fa fa-search-plus\"></i></button>';\n        content += '<button type=\"button\" class=\"btn btn-sm btn-outline-secondary\" ' +\n            'data-action=\"rotate\" title=\"Rotate\"><i class=\"fa fa-rotate-right\"></i></button>';\n\n        content += '</div>';\n        content += '</div>';\n\n        // Preview area.\n        content += '<div class=\"preview-area text-center\" style=\"max-height: 70vh; overflow: auto;\">';\n\n        if (isPdf) {\n            content += '<canvas class=\"preview-canvas border\"></canvas>';\n        } else if (isImage) {\n            content += '<img class=\"preview-image img-fluid border\" alt=\"' + filename + '\" ' +\n                'style=\"max-width: 100%; transition: transform 0.2s;\">';\n        } else {\n            content += '<div class=\"alert alert-info\">';\n            content += 'Preview not available for this file type. ';\n            content += '<a href=\"#\" class=\"download-link\">Download to view</a>';\n            content += '</div>';\n        }\n\n        content += '</div>';\n        content += '</div>';\n\n        return content;\n    };\n\n    /**\n     * Initialize preview controls.\n     *\n     * @param {Object} modal Modal instance.\n     * @param {string} url Document URL.\n     * @param {string} mimetype Document MIME type.\n     */\n    const initPreviewControls = function(modal, url, mimetype) {\n        const container = modal.getRoot()[0];\n        const isPdf = mimetype === 'application/pdf';\n        const isImage = mimetype.startsWith('image/');\n        let rotation = 0;\n\n        // Zoom controls.\n        container.querySelector('[data-action=\"zoom-in\"]').addEventListener('click', function() {\n            currentZoom = Math.min(currentZoom + 0.25, 3.0);\n            updateZoom(container, isPdf, isImage);\n        });\n\n        container.querySelector('[data-action=\"zoom-out\"]').addEventListener('click', function() {\n            currentZoom = Math.max(currentZoom - 0.25, 0.5);\n            updateZoom(container, isPdf, isImage);\n        });\n\n        // Rotation.\n        container.querySelector('[data-action=\"rotate\"]').addEventListener('click', function() {\n            rotation = (rotation + 90) % 360;\n            const target = isPdf ? container.querySelector('.preview-canvas') :\n                container.querySelector('.preview-image');\n            if (target) {\n                target.style.transform = 'rotate(' + rotation + 'deg) scale(' + currentZoom + ')';\n            }\n        });\n\n        // PDF navigation.\n        if (isPdf) {\n            container.querySelector('[data-action=\"prev-page\"]').addEventListener('click', function() {\n                displayPage(container, currentPage - 1);\n            });\n\n            container.querySelector('[data-action=\"next-page\"]').addEventListener('click', function() {\n                displayPage(container, currentPage + 1);\n            });\n        }\n\n        // Load content.\n        if (isPdf) {\n            loadPdfContent(container, url);\n        } else if (isImage) {\n            loadImageContent(container, url);\n        }\n\n        // Download link.\n        const downloadLink = container.querySelector('.download-link');\n        if (downloadLink) {\n            downloadLink.href = url;\n            downloadLink.target = '_blank';\n        }\n    };\n\n    /**\n     * Update zoom display.\n     *\n     * @param {HTMLElement} container Preview container.\n     * @param {boolean} isPdf Is PDF document.\n     * @param {boolean} isImage Is image document.\n     */\n    const updateZoom = function(container, isPdf, isImage) {\n        const zoomInfo = container.querySelector('.preview-zoom-info');\n        if (zoomInfo) {\n            zoomInfo.textContent = Math.round(currentZoom * 100) + '%';\n        }\n\n        if (isPdf && currentPdf) {\n            displayPage(container, currentPage);\n        } else if (isImage) {\n            const img = container.querySelector('.preview-image');\n            if (img) {\n                img.style.transform = 'scale(' + currentZoom + ')';\n            }\n        }\n    };\n\n    /**\n     * Load PDF content.\n     *\n     * @param {HTMLElement} container Preview container.\n     * @param {string} url PDF URL.\n     */\n    const loadPdfContent = function(container, url) {\n        const canvas = container.querySelector('.preview-canvas');\n\n        // Show loading indicator.\n        canvas.style.display = 'none';\n        const loading = document.createElement('div');\n        loading.className = 'preview-loading text-center py-5';\n        loading.innerHTML = '<i class=\"fa fa-spinner fa-spin fa-3x\"></i><p class=\"mt-2\">Loading PDF...</p>';\n        canvas.parentNode.insertBefore(loading, canvas);\n\n        loadPdfJs().then(function() {\n            return window.pdfjsLib.getDocument(url).promise;\n        }).then(function(pdf) {\n            currentPdf = pdf;\n            currentPage = 1;\n            loading.remove();\n            canvas.style.display = 'block';\n            return displayPage(container, 1);\n        }).catch(function(error) {\n            loading.innerHTML = '<div class=\"alert alert-danger\">' +\n                'Failed to load PDF: ' + error.message + '</div>';\n            // eslint-disable-next-line no-console\n            console.error('PDF load error:', error);\n        });\n    };\n\n    /**\n     * Load image content.\n     *\n     * @param {HTMLElement} container Preview container.\n     * @param {string} url Image URL.\n     */\n    const loadImageContent = function(container, url) {\n        const img = container.querySelector('.preview-image');\n        img.src = url;\n        img.onerror = function() {\n            img.parentNode.innerHTML = '<div class=\"alert alert-danger\">Failed to load image</div>';\n        };\n    };\n\n    /**\n     * Open document preview modal.\n     *\n     * @param {string} url Document URL.\n     * @param {string} filename Document filename.\n     * @param {string} mimetype Document MIME type.\n     */\n    const openPreview = function(url, filename, mimetype) {\n        // Reset state.\n        currentPdf = null;\n        currentPage = 1;\n        currentZoom = 1.0;\n\n        Str.get_string('previewdocument', 'local_jobboard').then(function(title) {\n            return ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title,\n                body: createPreviewContent(filename, mimetype),\n                large: true\n            });\n        }).then(function(modal) {\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            });\n\n            modal.show();\n            initPreviewControls(modal, url, mimetype);\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Initialize document preview functionality.\n     *\n     * Attaches event listeners to elements with data-preview-url attribute.\n     */\n    const init = function() {\n        $(document).on('click', '[data-preview-url]', function(e) {\n            e.preventDefault();\n\n            const $this = $(this);\n            const url = $this.data('preview-url');\n            const filename = $this.data('preview-filename') || 'Document';\n            const mimetype = $this.data('preview-mimetype') || 'application/pdf';\n\n            openPreview(url, filename, mimetype);\n        });\n    };\n\n    return {\n        init: init,\n        openPreview: openPreview\n    };\n});\n"],"names":["define","$","ModalFactory","ModalEvents","Str","Notification","pdfjsLoaded","currentPdf","currentPage","currentZoom","displayPage","container","pageNum","numPages","Promise","resolve","canvas","querySelector","getPage","then","page","zoom","viewport","getViewport","scale","context","getContext","height","width","render","canvasContext","promise","renderPage","pageInfo","textContent","prevBtn","nextBtn","disabled","updatePageDisplay","createPreviewContent","filename","mimetype","isPdf","isImage","startsWith","content","updateZoom","zoomInfo","Math","round","img","style","transform","loadPdfContent","url","display","loading","document","createElement","className","innerHTML","parentNode","insertBefore","reject","window","pdfjsLib","script","src","onload","GlobalWorkerOptions","workerSrc","onerror","Error","head","appendChild","getDocument","pdf","remove","catch","error","message","console","loadImageContent","openPreview","get_string","title","create","type","types","DEFAULT","body","large","modal","getRoot","on","hidden","destroy","show","rotation","addEventListener","min","max","target","downloadLink","href","initPreviewControls","exception","init","e","preventDefault","$this","this","data"],"mappings":"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"}