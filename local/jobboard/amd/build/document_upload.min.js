/**
 * Document upload module with drag & drop support.
 *
 * @module     local_jobboard/document_upload
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_jobboard/document_upload",["jquery","core/ajax","core/notification","core/str","core/templates"],(function($,Ajax,Notification,Str,Templates){var DocumentUpload=function(selector,config){this.container=$(selector),this.config=$.extend({maxSize:5242880,acceptedTypes:["application/pdf","image/jpeg","image/png"],uploadUrl:""},config),this.init()};return DocumentUpload.prototype.init=function(){this.registerEventListeners(),this.initDragDrop(),this.initFileInputLabels()},DocumentUpload.prototype.registerEventListeners=function(){var self=this;this.container.on("submit",".document-upload-form",(function(e){e.preventDefault(),self.handleFormSubmit($(this))})),this.container.on("change",".custom-file-input",(function(){self.updateFileLabel($(this)),self.validateFile($(this))})),this.container.on("click",".btn-reupload",(function(e){e.preventDefault(),$(this).closest(".document-upload-card").find(".document-upload-form").slideDown()})),this.container.on("click",".btn-cancel-reupload",(function(e){e.preventDefault(),$(this).closest(".document-upload-form").slideUp()}))},DocumentUpload.prototype.initDragDrop=function(){var self=this;this.container.find(".document-upload-card").each((function(){var card=$(this),form=card.find(".document-upload-form");0!==form.length&&(card.on("dragover dragenter",(function(e){e.preventDefault(),e.stopPropagation(),card.addClass("drag-over")})),card.on("dragleave dragend drop",(function(e){e.preventDefault(),e.stopPropagation(),card.removeClass("drag-over")})),card.on("drop",(function(e){var files=e.originalEvent.dataTransfer.files;if(files.length>0){var input=form.find(".custom-file-input");input[0].files=files,self.updateFileLabel(input),self.validateFile(input)&&form.submit()}})))}))},DocumentUpload.prototype.initFileInputLabels=function(){this.container.find(".custom-file-input").each((function(){var input=$(this);input[0].files&&input[0].files.length>0&&input.next(".custom-file-label").text(input[0].files[0].name)}))},DocumentUpload.prototype.updateFileLabel=function(input){var label=input.next(".custom-file-label");input[0].files&&input[0].files.length>0?label.text(input[0].files[0].name):Str.get_string("choosefiles","local_jobboard").then((function(str){return label.text(str),str})).catch(Notification.exception)},DocumentUpload.prototype.validateFile=function(input){var self=this,file=input[0].files[0],form=input.closest("form");return form.find(".upload-error").remove(),!!file&&(file.size>this.config.maxSize?(Str.get_string("error:filetoobig","local_jobboard").then((function(str){return self.showError(form,str),str})).catch(Notification.exception),input.val(""),this.updateFileLabel(input),!1):-1!==this.config.acceptedTypes.indexOf(file.type)||(Str.get_string("error:invalidformat","local_jobboard").then((function(str){return self.showError(form,str),str})).catch(Notification.exception),input.val(""),this.updateFileLabel(input),!1))},DocumentUpload.prototype.showError=function(form,message){var error=$('<div class="alert alert-danger upload-error mt-2"></div>').text(message);form.find(".form-group").first().after(error)},DocumentUpload.prototype.handleFormSubmit=function(form){var self=this,input=form.find(".custom-file-input");if(this.validateFile(input)){var submitButton=form.find('button[type="submit"]'),originalText=submitButton.html();submitButton.prop("disabled",!0),Str.get_string("processing","local_jobboard").then((function(str){return submitButton.html('<span class="spinner-border spinner-border-sm"></span> '+str),str})).catch(Notification.exception);var formData=new FormData(form[0]);$.ajax({url:form.attr("action"),type:"POST",data:formData,processData:!1,contentType:!1,dataType:"json"}).done((function(response){response.success?(self.refreshCard(form.closest(".document-upload-card"),response),Notification.addNotification({message:response.message,type:"success"})):self.showError(form,response.error)})).fail((function(jqXHR,textStatus,errorThrown){self.showError(form,errorThrown)})).always((function(){submitButton.prop("disabled",!1).html(originalText)}))}},DocumentUpload.prototype.refreshCard=function(card,response){response.html?card.replaceWith(response.html):response.templatedata?Templates.render("local_jobboard/document_upload",response.templatedata).then((function(html){return card.replaceWith(html),html})).catch(Notification.exception):(card.find(".document-upload-form").hide(),card.find(".current-file").show())},{init:function(selector,config){return new DocumentUpload(selector,config)}}}));

//# sourceMappingURL=document_upload.min.js.map