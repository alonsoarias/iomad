{"version":3,"file":"token_manager.min.js","sources":["../src/token_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * API Token management module.\n *\n * @module     local_jobboard/token_manager\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str', 'core/modal_factory', 'core/modal_events'],\n    function($, Ajax, Notification, Str, ModalFactory, ModalEvents) {\n\n    /**\n     * Token Manager class.\n     */\n    var TokenManager = function() {\n        this.registerEventListeners();\n    };\n\n    /**\n     * Register event listeners.\n     */\n    TokenManager.prototype.registerEventListeners = function() {\n        $(document).on('click', '.token-action', this.handleTokenAction.bind(this));\n        $(document).on('click', '.copy-token', this.copyTokenToClipboard.bind(this));\n    };\n\n    /**\n     * Handle token action button clicks.\n     *\n     * @param {Event} e Click event\n     */\n    TokenManager.prototype.handleTokenAction = function(e) {\n        e.preventDefault();\n        var button = $(e.currentTarget);\n        var action = button.data('action');\n        var tokenId = button.data('token-id');\n\n        switch (action) {\n            case 'revoke':\n                this.confirmAndRevoke(tokenId, button);\n                break;\n            case 'enable':\n                this.enableToken(tokenId, button);\n                break;\n            case 'delete':\n                this.confirmAndDelete(tokenId, button);\n                break;\n        }\n    };\n\n    /**\n     * Confirm and revoke a token.\n     *\n     * @param {number} tokenId Token ID\n     * @param {jQuery} button Button element\n     */\n    TokenManager.prototype.confirmAndRevoke = function(tokenId, button) {\n        var self = this;\n        var loadedStrings = null;\n        Str.get_strings([\n            {key: 'api:token:confirmrevoke', component: 'local_jobboard'},\n            {key: 'api:token:revoke', component: 'local_jobboard'},\n            {key: 'confirm', component: 'local_jobboard'},\n            {key: 'cancel', component: 'local_jobboard'}\n        ]).then(function(strings) {\n            loadedStrings = strings;\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: strings[1],\n                body: strings[0]\n            });\n        }).then(function(modal) {\n            modal.setSaveButtonText(loadedStrings[2]);\n            modal.getRoot().on(ModalEvents.save, function() {\n                self.revokeToken(tokenId, button);\n            });\n            modal.show();\n            return modal;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Revoke a token via AJAX.\n     *\n     * @param {number} tokenId Token ID\n     * @param {jQuery} button Button element\n     */\n    TokenManager.prototype.revokeToken = function(tokenId, button) {\n        var row = button.closest('tr');\n\n        Ajax.call([{\n            methodname: 'local_jobboard_revoke_token',\n            args: {tokenid: tokenId}\n        }])[0].then(function(response) {\n            if (response.success) {\n                // Update the row to show disabled status.\n                row.find('.badge').removeClass('badge-success').addClass('badge-secondary')\n                   .text(response.statuslabel);\n                button.data('action', 'enable')\n                      .removeClass('btn-outline-warning').addClass('btn-outline-success')\n                      .attr('title', response.enablelabel)\n                      .html('<i class=\"icon fa fa-eye\"></i>');\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n            }\n            return response;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Enable a token via AJAX.\n     *\n     * @param {number} tokenId Token ID\n     * @param {jQuery} button Button element\n     */\n    TokenManager.prototype.enableToken = function(tokenId, button) {\n        var row = button.closest('tr');\n\n        Ajax.call([{\n            methodname: 'local_jobboard_enable_token',\n            args: {tokenid: tokenId}\n        }])[0].then(function(response) {\n            if (response.success) {\n                row.find('.badge').removeClass('badge-secondary').addClass('badge-success')\n                   .text(response.statuslabel);\n                button.data('action', 'revoke')\n                      .removeClass('btn-outline-success').addClass('btn-outline-warning')\n                      .attr('title', response.revokelabel)\n                      .html('<i class=\"icon fa fa-eye-slash\"></i>');\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n            }\n            return response;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Confirm and delete a token.\n     *\n     * @param {number} tokenId Token ID\n     * @param {jQuery} button Button element\n     */\n    TokenManager.prototype.confirmAndDelete = function(tokenId, button) {\n        var self = this;\n        var loadedStrings = null;\n        Str.get_strings([\n            {key: 'api:token:confirmdelete', component: 'local_jobboard'},\n            {key: 'api:token:delete', component: 'local_jobboard'},\n            {key: 'confirm', component: 'local_jobboard'},\n            {key: 'cancel', component: 'local_jobboard'}\n        ]).then(function(strings) {\n            loadedStrings = strings;\n            return ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: strings[1],\n                body: strings[0]\n            });\n        }).then(function(modal) {\n            modal.setSaveButtonText(loadedStrings[2]);\n            modal.getRoot().on(ModalEvents.save, function() {\n                self.deleteToken(tokenId, button);\n            });\n            modal.show();\n            return modal;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Delete a token via AJAX.\n     *\n     * @param {number} tokenId Token ID\n     * @param {jQuery} button Button element\n     */\n    TokenManager.prototype.deleteToken = function(tokenId, button) {\n        var row = button.closest('tr');\n\n        Ajax.call([{\n            methodname: 'local_jobboard_delete_token',\n            args: {tokenid: tokenId}\n        }])[0].then(function(response) {\n            if (response.success) {\n                row.fadeOut(400, function() {\n                    $(this).remove();\n                });\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n            }\n            return response;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Copy token to clipboard.\n     *\n     * @param {Event} e Click event\n     */\n    TokenManager.prototype.copyTokenToClipboard = function(e) {\n        e.preventDefault();\n        var button = $(e.currentTarget);\n        var token = button.data('token');\n\n        if (navigator.clipboard && navigator.clipboard.writeText) {\n            navigator.clipboard.writeText(token).then(function() {\n                Str.get_string('api:token:copied', 'local_jobboard').then(function(str) {\n                    Notification.addNotification({\n                        message: str,\n                        type: 'success'\n                    });\n                    return str;\n                }).catch(Notification.exception);\n            }).catch(function() {\n                // Fallback for older browsers.\n                this.fallbackCopyToClipboard(token);\n            }.bind(this));\n        } else {\n            this.fallbackCopyToClipboard(token);\n        }\n    };\n\n    /**\n     * Fallback copy to clipboard for older browsers.\n     *\n     * @param {string} text Text to copy\n     */\n    TokenManager.prototype.fallbackCopyToClipboard = function(text) {\n        var textArea = document.createElement('textarea');\n        textArea.value = text;\n        textArea.style.position = 'fixed';\n        textArea.style.left = '-999999px';\n        document.body.appendChild(textArea);\n        textArea.focus();\n        textArea.select();\n        try {\n            document.execCommand('copy');\n            Str.get_string('api:token:copied', 'local_jobboard').then(function(str) {\n                Notification.addNotification({\n                    message: str,\n                    type: 'success'\n                });\n                return str;\n            }).catch(Notification.exception);\n        } catch (err) {\n            // Ignore errors.\n        }\n        document.body.removeChild(textArea);\n    };\n\n    return {\n        /**\n         * Initialize the token manager.\n         */\n        init: function() {\n            return new TokenManager();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","TokenManager","registerEventListeners","prototype","document","on","this","handleTokenAction","bind","copyTokenToClipboard","e","preventDefault","button","currentTarget","action","data","tokenId","confirmAndRevoke","enableToken","confirmAndDelete","self","loadedStrings","get_strings","key","component","then","strings","create","type","types","SAVE_CANCEL","title","body","modal","setSaveButtonText","getRoot","save","revokeToken","show","catch","exception","row","closest","call","methodname","args","tokenid","response","success","find","removeClass","addClass","text","statuslabel","attr","enablelabel","html","addNotification","message","revokelabel","deleteToken","fadeOut","remove","token","navigator","clipboard","writeText","get_string","str","fallbackCopyToClipboard","textArea","createElement","value","style","position","left","appendChild","focus","select","execCommand","err","removeChild","init"],"mappings":"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"}