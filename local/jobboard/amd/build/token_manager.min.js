/**
 * API Token management module.
 *
 * @module     local_jobboard/token_manager
 * @copyright  2024 ISER
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_jobboard/token_manager",["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events"],(function($,Ajax,Notification,Str,ModalFactory,ModalEvents){var TokenManager=function(){this.registerEventListeners()};return TokenManager.prototype.registerEventListeners=function(){$(document).on("click",".token-action",this.handleTokenAction.bind(this)),$(document).on("click",".copy-token",this.copyTokenToClipboard.bind(this))},TokenManager.prototype.handleTokenAction=function(e){e.preventDefault();var button=$(e.currentTarget),action=button.data("action"),tokenId=button.data("token-id");switch(action){case"revoke":this.confirmAndRevoke(tokenId,button);break;case"enable":this.enableToken(tokenId,button);break;case"delete":this.confirmAndDelete(tokenId,button)}},TokenManager.prototype.confirmAndRevoke=function(tokenId,button){var self=this,loadedStrings=null;Str.get_strings([{key:"api:token:confirmrevoke",component:"local_jobboard"},{key:"api:token:revoke",component:"local_jobboard"},{key:"confirm",component:"local_jobboard"},{key:"cancel",component:"local_jobboard"}]).then((function(strings){return loadedStrings=strings,ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[1],body:strings[0]})})).then((function(modal){return modal.setSaveButtonText(loadedStrings[2]),modal.getRoot().on(ModalEvents.save,(function(){self.revokeToken(tokenId,button)})),modal.show(),modal})).catch(Notification.exception)},TokenManager.prototype.revokeToken=function(tokenId,button){var row=button.closest("tr");Ajax.call([{methodname:"local_jobboard_revoke_token",args:{tokenid:tokenId}}])[0].then((function(response){return response.success&&(row.find(".badge").removeClass("badge-success").addClass("badge-secondary").text(response.statuslabel),button.data("action","enable").removeClass("btn-outline-warning").addClass("btn-outline-success").attr("title",response.enablelabel).html('<i class="icon fa fa-eye"></i>'),Notification.addNotification({message:response.message,type:"success"})),response})).catch(Notification.exception)},TokenManager.prototype.enableToken=function(tokenId,button){var row=button.closest("tr");Ajax.call([{methodname:"local_jobboard_enable_token",args:{tokenid:tokenId}}])[0].then((function(response){return response.success&&(row.find(".badge").removeClass("badge-secondary").addClass("badge-success").text(response.statuslabel),button.data("action","revoke").removeClass("btn-outline-success").addClass("btn-outline-warning").attr("title",response.revokelabel).html('<i class="icon fa fa-eye-slash"></i>'),Notification.addNotification({message:response.message,type:"success"})),response})).catch(Notification.exception)},TokenManager.prototype.confirmAndDelete=function(tokenId,button){var self=this,loadedStrings=null;Str.get_strings([{key:"api:token:confirmdelete",component:"local_jobboard"},{key:"api:token:delete",component:"local_jobboard"},{key:"confirm",component:"local_jobboard"},{key:"cancel",component:"local_jobboard"}]).then((function(strings){return loadedStrings=strings,ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[1],body:strings[0]})})).then((function(modal){return modal.setSaveButtonText(loadedStrings[2]),modal.getRoot().on(ModalEvents.save,(function(){self.deleteToken(tokenId,button)})),modal.show(),modal})).catch(Notification.exception)},TokenManager.prototype.deleteToken=function(tokenId,button){var row=button.closest("tr");Ajax.call([{methodname:"local_jobboard_delete_token",args:{tokenid:tokenId}}])[0].then((function(response){return response.success&&(row.fadeOut(400,(function(){$(this).remove()})),Notification.addNotification({message:response.message,type:"success"})),response})).catch(Notification.exception)},TokenManager.prototype.copyTokenToClipboard=function(e){e.preventDefault();var token=$(e.currentTarget).data("token");navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(token).then((function(){Str.get_string("api:token:copied","local_jobboard").then((function(str){return Notification.addNotification({message:str,type:"success"}),str})).catch(Notification.exception)})).catch(function(){this.fallbackCopyToClipboard(token)}.bind(this)):this.fallbackCopyToClipboard(token)},TokenManager.prototype.fallbackCopyToClipboard=function(text){var textArea=document.createElement("textarea");textArea.value=text,textArea.style.position="fixed",textArea.style.left="-999999px",document.body.appendChild(textArea),textArea.focus(),textArea.select();try{document.execCommand("copy"),Str.get_string("api:token:copied","local_jobboard").then((function(str){return Notification.addNotification({message:str,type:"success"}),str})).catch(Notification.exception)}catch(err){}document.body.removeChild(textArea)},{init:function(){return new TokenManager}}}));

//# sourceMappingURL=token_manager.min.js.map