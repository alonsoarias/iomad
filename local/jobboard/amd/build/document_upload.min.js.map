{"version":3,"file":"document_upload.min.js","sources":["../src/document_upload.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Document upload module with drag & drop support.\n *\n * @module     local_jobboard/document_upload\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str', 'core/templates'],\n    function($, Ajax, Notification, Str, Templates) {\n\n    /**\n     * Document Upload class.\n     *\n     * @param {string} selector Container selector\n     * @param {object} config Configuration options\n     */\n    var DocumentUpload = function(selector, config) {\n        this.container = $(selector);\n        this.config = $.extend({\n            maxSize: 5242880, // 5MB\n            acceptedTypes: ['application/pdf', 'image/jpeg', 'image/png'],\n            uploadUrl: ''\n        }, config);\n\n        this.init();\n    };\n\n    /**\n     * Initialize the document upload.\n     */\n    DocumentUpload.prototype.init = function() {\n        this.registerEventListeners();\n        this.initDragDrop();\n        this.initFileInputLabels();\n    };\n\n    /**\n     * Register event listeners.\n     */\n    DocumentUpload.prototype.registerEventListeners = function() {\n        var self = this;\n\n        // Form submission.\n        this.container.on('submit', '.document-upload-form', function(e) {\n            e.preventDefault();\n            self.handleFormSubmit($(this));\n        });\n\n        // File input change.\n        this.container.on('change', '.custom-file-input', function() {\n            self.updateFileLabel($(this));\n            self.validateFile($(this));\n        });\n\n        // Re-upload button.\n        this.container.on('click', '.btn-reupload', function(e) {\n            e.preventDefault();\n            var card = $(this).closest('.document-upload-card');\n            card.find('.document-upload-form').slideDown();\n        });\n\n        // Cancel re-upload.\n        this.container.on('click', '.btn-cancel-reupload', function(e) {\n            e.preventDefault();\n            $(this).closest('.document-upload-form').slideUp();\n        });\n    };\n\n    /**\n     * Initialize drag & drop functionality.\n     */\n    DocumentUpload.prototype.initDragDrop = function() {\n        var self = this;\n\n        this.container.find('.document-upload-card').each(function() {\n            var card = $(this);\n            var form = card.find('.document-upload-form');\n\n            if (form.length === 0) {\n                return;\n            }\n\n            card.on('dragover dragenter', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                card.addClass('drag-over');\n            });\n\n            card.on('dragleave dragend drop', function(e) {\n                e.preventDefault();\n                e.stopPropagation();\n                card.removeClass('drag-over');\n            });\n\n            card.on('drop', function(e) {\n                var files = e.originalEvent.dataTransfer.files;\n                if (files.length > 0) {\n                    var input = form.find('.custom-file-input');\n                    input[0].files = files;\n                    self.updateFileLabel(input);\n                    if (self.validateFile(input)) {\n                        form.submit();\n                    }\n                }\n            });\n        });\n    };\n\n    /**\n     * Initialize file input labels.\n     */\n    DocumentUpload.prototype.initFileInputLabels = function() {\n        this.container.find('.custom-file-input').each(function() {\n            var input = $(this);\n            if (input[0].files && input[0].files.length > 0) {\n                var label = input.next('.custom-file-label');\n                label.text(input[0].files[0].name);\n            }\n        });\n    };\n\n    /**\n     * Update file input label with selected filename.\n     *\n     * @param {jQuery} input File input element\n     */\n    DocumentUpload.prototype.updateFileLabel = function(input) {\n        var label = input.next('.custom-file-label');\n        if (input[0].files && input[0].files.length > 0) {\n            label.text(input[0].files[0].name);\n        } else {\n            Str.get_string('choosefiles', 'local_jobboard').then(function(str) {\n                label.text(str);\n                return str;\n            }).catch(Notification.exception);\n        }\n    };\n\n    /**\n     * Validate file before upload.\n     *\n     * @param {jQuery} input File input element\n     * @return {boolean} True if valid\n     */\n    DocumentUpload.prototype.validateFile = function(input) {\n        var self = this;\n        var file = input[0].files[0];\n        var form = input.closest('form');\n        var errorContainer = form.find('.upload-error');\n\n        // Remove previous errors.\n        errorContainer.remove();\n\n        if (!file) {\n            return false;\n        }\n\n        // Check file size.\n        if (file.size > this.config.maxSize) {\n            Str.get_string('error:filetoobig', 'local_jobboard').then(function(str) {\n                self.showError(form, str);\n                return str;\n            }).catch(Notification.exception);\n            input.val('');\n            this.updateFileLabel(input);\n            return false;\n        }\n\n        // Check file type.\n        if (this.config.acceptedTypes.indexOf(file.type) === -1) {\n            Str.get_string('error:invalidformat', 'local_jobboard').then(function(str) {\n                self.showError(form, str);\n                return str;\n            }).catch(Notification.exception);\n            input.val('');\n            this.updateFileLabel(input);\n            return false;\n        }\n\n        return true;\n    };\n\n    /**\n     * Show error message.\n     *\n     * @param {jQuery} form Form element\n     * @param {string} message Error message\n     */\n    DocumentUpload.prototype.showError = function(form, message) {\n        var error = $('<div class=\"alert alert-danger upload-error mt-2\"></div>').text(message);\n        form.find('.form-group').first().after(error);\n    };\n\n    /**\n     * Handle form submission.\n     *\n     * @param {jQuery} form Form element\n     */\n    DocumentUpload.prototype.handleFormSubmit = function(form) {\n        var self = this;\n        var input = form.find('.custom-file-input');\n\n        if (!this.validateFile(input)) {\n            return;\n        }\n\n        var submitButton = form.find('button[type=\"submit\"]');\n        var originalText = submitButton.html();\n\n        // Show loading state.\n        submitButton.prop('disabled', true);\n        Str.get_string('processing', 'local_jobboard').then(function(str) {\n            submitButton.html('<span class=\"spinner-border spinner-border-sm\"></span> ' + str);\n            return str;\n        }).catch(Notification.exception);\n\n        var formData = new FormData(form[0]);\n\n        $.ajax({\n            url: form.attr('action'),\n            type: 'POST',\n            data: formData,\n            processData: false,\n            contentType: false,\n            dataType: 'json'\n        }).done(function(response) {\n            if (response.success) {\n                // Refresh the card with new content.\n                self.refreshCard(form.closest('.document-upload-card'), response);\n                Notification.addNotification({\n                    message: response.message,\n                    type: 'success'\n                });\n            } else {\n                self.showError(form, response.error);\n            }\n        }).fail(function(jqXHR, textStatus, errorThrown) {\n            self.showError(form, errorThrown);\n        }).always(function() {\n            submitButton.prop('disabled', false).html(originalText);\n        });\n    };\n\n    /**\n     * Refresh document card after upload.\n     *\n     * @param {jQuery} card Card element\n     * @param {object} response Server response\n     */\n    DocumentUpload.prototype.refreshCard = function(card, response) {\n        if (response.html) {\n            card.replaceWith(response.html);\n        } else if (response.templatedata) {\n            Templates.render('local_jobboard/document_upload', response.templatedata)\n                .then(function(html) {\n                    card.replaceWith(html);\n                    return html;\n                })\n                .catch(Notification.exception);\n        } else {\n            // Simple update.\n            card.find('.document-upload-form').hide();\n            card.find('.current-file').show();\n        }\n    };\n\n    return {\n        /**\n         * Initialize document upload.\n         *\n         * @param {string} selector Container selector\n         * @param {object} config Configuration options\n         */\n        init: function(selector, config) {\n            return new DocumentUpload(selector, config);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","Templates","DocumentUpload","selector","config","container","extend","maxSize","acceptedTypes","uploadUrl","init","prototype","registerEventListeners","initDragDrop","initFileInputLabels","self","this","on","e","preventDefault","handleFormSubmit","updateFileLabel","validateFile","closest","find","slideDown","slideUp","each","card","form","length","stopPropagation","addClass","removeClass","files","originalEvent","dataTransfer","input","submit","next","text","name","label","get_string","then","str","catch","exception","file","remove","size","showError","val","indexOf","type","message","error","first","after","submitButton","originalText","html","prop","formData","FormData","ajax","url","attr","data","processData","contentType","dataType","done","response","success","refreshCard","addNotification","fail","jqXHR","textStatus","errorThrown","always","replaceWith","templatedata","render","hide","show"],"mappings":"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"}