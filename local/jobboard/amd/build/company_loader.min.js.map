{"version":3,"file":"company_loader.min.js","sources":["../src/company_loader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for dynamic company loading with autocomplete/search functionality.\n *\n * This module provides AJAX-based company selection for forms and filters.\n * It supports both autocomplete search and standard select dropdown modes.\n *\n * @module     local_jobboard/company_loader\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'local_jobboard/department_loader'], function($, Str, DepartmentLoader) {\n    'use strict';\n\n    /**\n     * Load companies via AJAX.\n     *\n     * @param {string} search Optional search term.\n     * @param {number} companyId Optional specific company ID to load.\n     * @return {Promise} Promise resolving to array of companies.\n     */\n    var loadCompanies = function(search, companyId) {\n        return new Promise(function(resolve, reject) {\n            var data = {};\n            if (search) {\n                data.search = search;\n            }\n            if (companyId) {\n                data.id = companyId;\n            }\n\n            $.ajax({\n                url: M.cfg.wwwroot + '/local/jobboard/ajax/get_companies.php',\n                method: 'GET',\n                data: data,\n                dataType: 'json'\n            }).done(function(response) {\n                if (response.success) {\n                    resolve(response.companies);\n                } else {\n                    reject(response.error || 'Unknown error');\n                }\n            }).fail(function(jqXHR, textStatus, errorThrown) {\n                reject(textStatus + ': ' + errorThrown);\n            });\n        });\n    };\n\n    /**\n     * Populate a select element with companies.\n     *\n     * @param {jQuery} selectElement The select element to populate.\n     * @param {Array} companies Array of company objects.\n     * @param {number} preselect Optional company ID to preselect.\n     * @param {string} placeholder Placeholder text for empty option.\n     */\n    var populateSelect = function(selectElement, companies, preselect, placeholder) {\n        selectElement.empty();\n\n        // Add placeholder option.\n        selectElement.append($('<option>', {\n            value: 0,\n            text: placeholder || 'Seleccionar...'\n        }));\n\n        // Add company options.\n        $.each(companies, function(index, company) {\n            var option = $('<option>', {\n                value: company.id,\n                text: company.name\n            });\n            if (preselect && parseInt(preselect, 10) === parseInt(company.id, 10)) {\n                option.prop('selected', true);\n            }\n            selectElement.append(option);\n        });\n    };\n\n    /**\n     * Initialize company loader for a select element with search capability.\n     *\n     * @param {Object} options Configuration options.\n     * @param {string} options.companySelector Selector for company element.\n     * @param {string} options.departmentSelector Optional selector for department element (for cascading).\n     * @param {number} options.preselect Optional company ID to preselect.\n     * @param {string} options.placeholder Placeholder text.\n     * @param {boolean} options.enableSearch Enable search functionality.\n     */\n    var init = function(options) {\n        options = options || {};\n\n        var companySelect = $(options.companySelector);\n        if (!companySelect.length) {\n            return;\n        }\n\n        var placeholder = options.placeholder || '';\n        var preselect = options.preselect || 0;\n\n        // Get placeholder from language string if not provided.\n        if (!placeholder) {\n            Str.get_string('selectcompany', 'local_jobboard').done(function(str) {\n                placeholder = str;\n            });\n        }\n\n        // Load companies initially.\n        loadCompanies().then(function(companies) {\n            populateSelect(companySelect, companies, preselect, placeholder);\n\n            // If preselect is set and we have a department selector, trigger department load.\n            if (preselect && options.departmentSelector) {\n                var deptSelect = $(options.departmentSelector);\n                if (deptSelect.length) {\n                    DepartmentLoader.loadDepartments(deptSelect, preselect, options.departmentPreselect);\n                }\n            }\n        }).catch(function(error) {\n            // eslint-disable-next-line no-console\n            console.error('Error loading companies:', error);\n        });\n\n        // Handle company change to load departments.\n        if (options.departmentSelector) {\n            companySelect.on('change', function() {\n                var companyId = $(this).val();\n                var deptSelect = $(options.departmentSelector);\n                if (deptSelect.length) {\n                    DepartmentLoader.loadDepartments(deptSelect, companyId);\n                }\n            });\n        }\n\n        // Enable search functionality if requested.\n        if (options.enableSearch) {\n            initSearchableSelect(companySelect, placeholder);\n        }\n    };\n\n    /**\n     * Initialize searchable select with autocomplete.\n     *\n     * @param {jQuery} selectElement The select element.\n     * @param {string} placeholder Placeholder text.\n     */\n    var initSearchableSelect = function(selectElement, placeholder) {\n        // Create search wrapper.\n        var wrapper = $('<div>', {'class': 'jb-company-search-wrapper position-relative'});\n        var searchInput = $('<input>', {\n            'type': 'text',\n            'class': 'form-control jb-company-search',\n            'placeholder': placeholder,\n            'autocomplete': 'off'\n        });\n        var dropdown = $('<div>', {'class': 'jb-company-dropdown dropdown-menu w-100', 'style': 'display:none;'});\n\n        // Wrap the original select.\n        selectElement.wrap(wrapper);\n        selectElement.before(searchInput);\n        selectElement.after(dropdown);\n        selectElement.hide();\n\n        var searchTimeout = null;\n\n        // Handle search input.\n        searchInput.on('input', function() {\n            var searchTerm = $(this).val();\n\n            if (searchTimeout) {\n                clearTimeout(searchTimeout);\n            }\n\n            if (searchTerm.length < 2) {\n                dropdown.hide();\n                return;\n            }\n\n            searchTimeout = setTimeout(function() {\n                loadCompanies(searchTerm).then(function(companies) {\n                    dropdown.empty();\n                    if (companies.length === 0) {\n                        Str.get_string('noresults', 'local_jobboard').done(function(str) {\n                            dropdown.append($('<div>', {\n                                'class': 'dropdown-item text-muted',\n                                'text': str\n                            }));\n                        });\n                    } else {\n                        $.each(companies, function(index, company) {\n                            var item = $('<a>', {\n                                'class': 'dropdown-item',\n                                'href': '#',\n                                'text': company.name,\n                                'data-id': company.id\n                            });\n                            item.on('click', function(e) {\n                                e.preventDefault();\n                                selectElement.val(company.id).trigger('change');\n                                searchInput.val(company.name);\n                                dropdown.hide();\n                            });\n                            dropdown.append(item);\n                        });\n                    }\n                    dropdown.show();\n                }).catch(function(error) {\n                    // eslint-disable-next-line no-console\n                    console.error('Search error:', error);\n                });\n            }, 300);\n        });\n\n        // Hide dropdown on blur.\n        searchInput.on('blur', function() {\n            setTimeout(function() {\n                dropdown.hide();\n            }, 200);\n        });\n\n        // Show dropdown on focus if has value.\n        searchInput.on('focus', function() {\n            if ($(this).val().length >= 2) {\n                dropdown.show();\n            }\n        });\n\n        // Set initial value if preselected.\n        var selectedOption = selectElement.find('option:selected');\n        if (selectedOption.val() && selectedOption.val() !== '0') {\n            searchInput.val(selectedOption.text());\n        }\n    };\n\n    /**\n     * Initialize for filter forms (simpler version without search box).\n     *\n     * @param {Object} options Configuration options.\n     */\n    var initFilter = function(options) {\n        options = options || {};\n\n        var companySelect = $(options.companySelector || '#filter-companyid');\n        var departmentSelect = $(options.departmentSelector || '#filter-departmentid');\n\n        if (!companySelect.length) {\n            return;\n        }\n\n        // Handle company change.\n        companySelect.on('change', function() {\n            var companyId = $(this).val();\n            if (departmentSelect.length) {\n                DepartmentLoader.loadDepartments(\n                    departmentSelect,\n                    companyId,\n                    null,\n                    options.allDepartmentsLabel\n                );\n            }\n        });\n\n        // Load departments if company is pre-selected.\n        var initialCompany = companySelect.val();\n        if (initialCompany && initialCompany !== '0') {\n            DepartmentLoader.loadDepartments(\n                departmentSelect,\n                initialCompany,\n                options.departmentPreselect,\n                options.allDepartmentsLabel\n            );\n        }\n    };\n\n    return {\n        init: init,\n        initFilter: initFilter,\n        loadCompanies: loadCompanies,\n        populateSelect: populateSelect\n    };\n});\n"],"names":["define","$","Str","DepartmentLoader","loadCompanies","search","companyId","Promise","resolve","reject","data","id","ajax","url","M","cfg","wwwroot","method","dataType","done","response","success","companies","error","fail","jqXHR","textStatus","errorThrown","populateSelect","selectElement","preselect","placeholder","empty","append","value","text","each","index","company","option","name","parseInt","prop","initSearchableSelect","wrapper","searchInput","dropdown","wrap","before","after","hide","searchTimeout","on","searchTerm","this","val","clearTimeout","length","setTimeout","then","get_string","str","item","e","preventDefault","trigger","show","catch","console","selectedOption","find","init","options","companySelect","companySelector","departmentSelector","deptSelect","loadDepartments","departmentPreselect","enableSearch","initFilter","departmentSelect","allDepartmentsLabel","initialCompany"],"mappings":"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"}