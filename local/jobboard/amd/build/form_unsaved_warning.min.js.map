{"version":3,"file":"form_unsaved_warning.min.js","sources":["../src/form_unsaved_warning.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Form unsaved changes warning module.\n *\n * Shows a confirmation dialog when the user tries to leave a page\n * with unsaved form changes.\n *\n * @module     local_jobboard/form_unsaved_warning\n * @copyright  2024 ISER\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/str', 'core/notification'], function($, Str, Notification) {\n    'use strict';\n\n    /**\n     * Module state.\n     */\n    var state = {\n        formSelector: 'form.mform',\n        initialFormData: null,\n        hasChanges: false,\n        isSubmitting: false,\n        warningMessage: '',\n        excludedLinks: ['.btn-cancel', '[data-action=\"cancel\"]', '[type=\"submit\"]']\n    };\n\n    /**\n     * Get current form data as a serialized string.\n     *\n     * @param {jQuery} form - The form element.\n     * @returns {string} Serialized form data.\n     */\n    var getFormData = function(form) {\n        return form.serialize();\n    };\n\n    /**\n     * Check if the form has unsaved changes.\n     *\n     * @returns {boolean} True if there are unsaved changes.\n     */\n    var checkForChanges = function() {\n        var form = $(state.formSelector);\n        if (form.length === 0 || state.initialFormData === null) {\n            return false;\n        }\n        var currentData = getFormData(form);\n        return currentData !== state.initialFormData;\n    };\n\n    /**\n     * Update the hasChanges state.\n     */\n    var updateChangesState = function() {\n        state.hasChanges = checkForChanges();\n    };\n\n    /**\n     * Show warning before leaving the page.\n     *\n     * @param {Event} e - The beforeunload event.\n     * @returns {string|undefined} Warning message or undefined.\n     */\n    var beforeUnloadHandler = function(e) {\n        if (state.hasChanges && !state.isSubmitting) {\n            e.preventDefault();\n            e.returnValue = state.warningMessage;\n            return state.warningMessage;\n        }\n    };\n\n    /**\n     * Handle click on links that would navigate away.\n     *\n     * @param {Event} e - The click event.\n     */\n    var handleLinkClick = function(e) {\n        // Skip if form is being submitted.\n        if (state.isSubmitting) {\n            return;\n        }\n\n        // Skip if no changes.\n        if (!state.hasChanges) {\n            return;\n        }\n\n        var link = $(e.currentTarget);\n\n        // Skip excluded links (cancel buttons, submit buttons, etc.).\n        for (var i = 0; i < state.excludedLinks.length; i++) {\n            if (link.is(state.excludedLinks[i])) {\n                return;\n            }\n        }\n\n        // Skip if it's an anchor link or inline script link.\n        var href = link.attr('href');\n        // eslint-disable-next-line no-script-url\n        if (!href || href === '#' || href.indexOf('javascript' + ':') === 0) {\n            return;\n        }\n\n        // Prevent navigation and show confirmation.\n        e.preventDefault();\n\n        Notification.confirm(\n            Str.get_string('unsavedchanges', 'local_jobboard'),\n            state.warningMessage,\n            Str.get_string('leave', 'local_jobboard'),\n            Str.get_string('stay', 'local_jobboard'),\n            function() {\n                // User confirmed - navigate away.\n                state.hasChanges = false;\n                window.location.href = href;\n            }\n        );\n    };\n\n    /**\n     * Handle form submission.\n     */\n    var handleFormSubmit = function() {\n        state.isSubmitting = true;\n    };\n\n    /**\n     * Initialize the module.\n     *\n     * @param {Object} config - Configuration options.\n     * @param {string} [config.formSelector] - CSS selector for the form.\n     * @param {Array} [config.excludedLinks] - Array of selectors for links to exclude.\n     */\n    var init = function(config) {\n        config = config || {};\n\n        // Apply configuration.\n        if (config.formSelector) {\n            state.formSelector = config.formSelector;\n        }\n        if (config.excludedLinks) {\n            state.excludedLinks = state.excludedLinks.concat(config.excludedLinks);\n        }\n\n        // Load warning message string.\n        Str.get_string('unsavedchangeswarning', 'local_jobboard').done(function(str) {\n            state.warningMessage = str;\n        }).fail(function() {\n            state.warningMessage = 'You have unsaved changes. Are you sure you want to leave this page?';\n        });\n\n        // Wait for DOM to be ready.\n        $(document).ready(function() {\n            var form = $(state.formSelector);\n\n            if (form.length === 0) {\n                return;\n            }\n\n            // Store initial form data.\n            // Small delay to allow dynamic fields to initialize.\n            setTimeout(function() {\n                state.initialFormData = getFormData(form);\n            }, 500);\n\n            // Listen for form changes.\n            form.on('change input', 'input, select, textarea', function() {\n                updateChangesState();\n            });\n\n            // Handle form submission.\n            form.on('submit', handleFormSubmit);\n\n            // Handle cancel button clicks.\n            form.find('[name=\"cancel\"], .btn-cancel').on('click', function() {\n                state.isSubmitting = true;\n            });\n\n            // Listen for beforeunload.\n            $(window).on('beforeunload', beforeUnloadHandler);\n\n            // Listen for clicks on navigation links.\n            $('a').not(state.excludedLinks.join(', ')).on('click', handleLinkClick);\n\n            // Also handle the navigation footer links.\n            $('.jb-navigation-footer a').on('click', handleLinkClick);\n        });\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Str","Notification","state","formSelector","initialFormData","hasChanges","isSubmitting","warningMessage","excludedLinks","getFormData","form","serialize","updateChangesState","length","beforeUnloadHandler","e","preventDefault","returnValue","handleLinkClick","link","currentTarget","i","is","href","attr","indexOf","confirm","get_string","window","location","handleFormSubmit","init","config","concat","done","str","fail","document","ready","setTimeout","on","find","not","join"],"mappings":";;;;;;;;;;AA0BAA,6CAAO,CAAC,SAAU,WAAY,sBAAsB,SAASC,EAAGC,IAAKC,kBAM7DC,MAAQ,CACRC,aAAc,aACdC,gBAAiB,KACjBC,YAAY,EACZC,cAAc,EACdC,eAAgB,GAChBC,cAAe,CAAC,cAAe,yBAA0B,oBASzDC,YAAc,SAASC,aAChBA,KAAKC,aAoBZC,mBAAqB,WAZH,IACdF,KAYJR,MAAMG,WAXc,KADhBK,KAAOX,EAAEG,MAAMC,eACVU,QAA0C,OAA1BX,MAAME,iBAGbK,YAAYC,QACPR,MAAME,iBAgB7BU,oBAAsB,SAASC,MAC3Bb,MAAMG,aAAeH,MAAMI,oBAC3BS,EAAEC,iBACFD,EAAEE,YAAcf,MAAMK,eACfL,MAAMK,gBASjBW,gBAAkB,SAASH,OAEvBb,MAAMI,cAKLJ,MAAMG,oBAIPc,KAAOpB,EAAEgB,EAAEK,eAGNC,EAAI,EAAGA,EAAInB,MAAMM,cAAcK,OAAQQ,OACxCF,KAAKG,GAAGpB,MAAMM,cAAca,eAMhCE,KAAOJ,KAAKK,KAAK,QAEhBD,MAAiB,MAATA,MAAqD,IAArCA,KAAKE,QAAQ,iBAK1CV,EAAEC,iBAEFf,aAAayB,QACT1B,IAAI2B,WAAW,iBAAkB,kBACjCzB,MAAMK,eACNP,IAAI2B,WAAW,QAAS,kBACxB3B,IAAI2B,WAAW,OAAQ,mBACvB,WAEIzB,MAAMG,YAAa,EACnBuB,OAAOC,SAASN,KAAOA,WAQ/BO,iBAAmB,WACnB5B,MAAMI,cAAe,SAkElB,CACHyB,KAzDO,SAASC,SAChBA,OAASA,QAAU,IAGR7B,eACPD,MAAMC,aAAe6B,OAAO7B,cAE5B6B,OAAOxB,gBACPN,MAAMM,cAAgBN,MAAMM,cAAcyB,OAAOD,OAAOxB,gBAI5DR,IAAI2B,WAAW,wBAAyB,kBAAkBO,MAAK,SAASC,KACpEjC,MAAMK,eAAiB4B,OACxBC,MAAK,WACJlC,MAAMK,eAAiB,yEAI3BR,EAAEsC,UAAUC,OAAM,eACV5B,KAAOX,EAAEG,MAAMC,cAEC,IAAhBO,KAAKG,SAMT0B,YAAW,WACPrC,MAAME,gBAAkBK,YAAYC,QACrC,KAGHA,KAAK8B,GAAG,eAAgB,2BAA2B,WAC/C5B,wBAIJF,KAAK8B,GAAG,SAAUV,kBAGlBpB,KAAK+B,KAAK,gCAAgCD,GAAG,SAAS,WAClDtC,MAAMI,cAAe,KAIzBP,EAAE6B,QAAQY,GAAG,eAAgB1B,qBAG7Bf,EAAE,KAAK2C,IAAIxC,MAAMM,cAAcmC,KAAK,OAAOH,GAAG,QAAStB,iBAGvDnB,EAAE,2BAA2ByC,GAAG,QAAStB"}