define("local_edwiserpagebuilder/addblockmodal",["exports","local_edwiserpagebuilder/jquery","core/modal_factory","core/modal_events","core/templates","core/str","core/ajax","local_edwiserpagebuilder/blockmanager"],(function(_exports,_jquery,_modal_factory,_modal_events,_templates,_str,_ajax,_blockmanager){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Show an add block modal instead of doing it on a separate page.
   *
   * @module     core/addblockmodal
   * @copyright  2016 Damyon Wiese <damyon@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_blockmanager=_interopRequireDefault(_blockmanager);const SELECTORS_ADD_BLOCK='[data-key="addblock"]';let listenerEventsRegistered=!1;const registerListenerEvents=async(pageType,pageLayout,addBlockUrl,subPage,issiteadmin,edwepbf,pbfnotenable)=>{document.addEventListener("click",(e=>{const addBlock=e.target.closest(SELECTORS_ADD_BLOCK);if(addBlock){e.preventDefault();let addBlockModal=null,addBlockModalUrl=null!=addBlockUrl?addBlockUrl:addBlock.dataset.url;buildAddBlockModal().then((async modal=>{modal.getRoot().addClass("epb_custom_modal");const $root=modal.getRoot(),rootEl=$root.get(0);function preventOutsideClick(e){e.preventDefault()}function preventEscKey(e){!e||"Escape"!==e.key&&27!==e.keyCode&&27!==e.which||(e.preventDefault(),e.stopImmediatePropagation())}modal.getRoot().on(_modal_events.default.cancel,(function(e){e.preventDefault(),modal.destroy()})),addBlockModal=modal,_templates.default.render("local_edwiserpagebuilder/add_block_body_overlay",{}).then((overlay=>{modal.setBody(overlay),$root.attr("data-backdrop","static"),$root.attr("data-keyboard","false"),$root.on(_modal_events.default.outsideClick,preventOutsideClick),rootEl&&rootEl.addEventListener("keydown",preventEscKey,!0),modal.show(),setTimeout((()=>{const progressBar=document.querySelector("#add-block-overlay-bar"),progressText=document.querySelector("#add-block-overlay-progress");if(progressBar&&progressText){const progress=createProgressVisualization({progressBar:progressBar,progressText:progressText,onComplete:()=>{console.log("Progress visualization completed!")}});progress.start(),getFetchBlocks().then((fetchallblocks=>{progress.complete();const modalBody=renderBlocks(addBlockModalUrl,pageType,pageLayout,subPage,issiteadmin,edwepbf,pbfnotenable);return modal.setBody(modalBody),_blockmanager.default.load(addBlockModalUrl,pageType),$root.removeAttr("data-backdrop"),$root.removeAttr("data-keyboard"),$root.off(_modal_events.default.outsideClick,preventOutsideClick),rootEl&&rootEl.removeEventListener("keydown",preventEscKey,!0),modalBody}))}}),150)}))})).catch((()=>{addBlockModal.destroy()}))}}))},buildAddBlockModal=()=>_modal_factory.default.create({type:_modal_factory.default.types.CANCEL,title:(0,_str.get_string)("addblock")}),renderBlocks=async(addBlockUrl,pageType,pageLayout,subPage,issiteadmin,edwepbf,pbfnotenable)=>{var _blockscontext,_blockscontext2,_blockscontext3,_blockscontext4;let blockscontext=await getAddableBlocks(pageType,pageLayout,subPage);blockscontext=JSON.parse(blockscontext);var filterplugindata=!1,showfilterreleaseinfo=!1;if(edwepbf&&!pbfnotenable){filterplugindata=await getfilterpluginstatus();(filterplugindata=JSON.parse(filterplugindata)).release<="4.2.2"&&(pbfnotenable=!1,showfilterreleaseinfo=!0)}var showmodalsecondnav=!1;"undefined"!=typeof edwremuithemeinfo&&"available"==edwremuithemeinfo&&(showmodalsecondnav=!0);var match=addBlockUrl.match(/[?&]bui_blockregion=([^&]+)/),region=match?match[1]:"";return _templates.default.render("local_edwiserpagebuilder/add_block_body",{blockscontext:null===(_blockscontext=blockscontext)||void 0===_blockscontext?void 0:_blockscontext.blockscontext,htmlblock:null===(_blockscontext2=blockscontext)||void 0===_blockscontext2?void 0:_blockscontext2.htmlblock,importblock:null===(_blockscontext3=blockscontext)||void 0===_blockscontext3?void 0:_blockscontext3.importblock,categories:null===(_blockscontext4=blockscontext)||void 0===_blockscontext4?void 0:_blockscontext4.categories,moodleblock:blockscontext.moodleblock,url:addBlockUrl,isadmin:issiteadmin,pbfpluginexist:edwepbf,edwpbfnotenable:pbfnotenable,blockpagetype:pageType,blockregion:region,showsecondmenu:showmodalsecondnav,showfilterreleasenotice:showfilterreleaseinfo})},getAddableBlocks=async(pageType,pageLayout,subPage)=>{const request={methodname:"local_edwiserpagebuilder_fetch_addable_blocks",args:{pagecontextid:M.cfg.contextid,pagetype:pageType,pagelayout:pageLayout,subpage:subPage}};return _ajax.default.call([request])[0]},getFetchBlocks=function(){let retryCount=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return setTimeout((()=>{(0,_jquery.default)("#add-block-installing-blocks-placeholder-wrapper").removeClass("d-none")}),400),new Promise(((resolve,reject)=>{(async()=>{try{const progressBar=document.querySelector("#add-block-overlay-bar"),progressText=document.querySelector("#add-block-overlay-progress");let progress;progressBar&&progressText&&(progress=createProgressVisualization({progressBar:progressBar,progressText:progressText,onComplete:()=>{console.log("Progress visualization completed!")}}),progress.start());const initialResponse=await makeBatchRequest(20,0);if(console.log("Initial response:",initialResponse),initialResponse&&initialResponse.result)if(initialResponse.result.limit>0&&!initialResponse.result.complete){if(console.log("Batching mode detected, processing in batches..."),progress){const initialProgress=Math.round(initialResponse.result.processed/initialResponse.result.total*100);progress.setTarget(initialProgress)}await processBatches(initialResponse,progressBar,progressText,progress)}else console.log("Backward compatibility mode - all blocks processed"),progress&&progress.setTarget(100);else console.error("Invalid initial response:",initialResponse);resolve(!0)}catch(error){console.error("Error in block fetching:",error),retryCount<6?(console.log("Failed attempt: "+error),setTimeout((()=>{getFetchBlocks(retryCount+1).then(resolve).catch(reject)}),24e4*retryCount)):resolve(!1)}})()}))},processBatches=async(initialResponse,progressBar,progressText,progress)=>{let offset=0;let totalBlocks=initialResponse.result.total,processedBlocks=initialResponse.result.processed,isComplete=initialResponse.result.complete;console.log("Initial batch: ".concat(processedBlocks,"/").concat(totalBlocks," blocks, Complete: ").concat(isComplete));let batchCount=1;for(;!isComplete;){batchCount++,offset=initialResponse.result.next_offset,console.log("Making batch ".concat(batchCount," request with offset: ").concat(offset));const batchResponse=await makeBatchRequest(20,offset);if(console.log("Batch ".concat(batchCount," response:"),batchResponse),!batchResponse||!batchResponse.result){console.error("Batch ".concat(batchCount," failed:"),batchResponse);break}if(processedBlocks+=batchResponse.result.processed,isComplete=batchResponse.result.complete,console.log("Batch ".concat(batchCount," completed: ").concat(batchResponse.result.processed," blocks, Total processed: ").concat(processedBlocks,"/").concat(totalBlocks)),progress){const currentProgress=Math.round(processedBlocks/totalBlocks*100);progress.setTarget(currentProgress),console.log("Setting progress target to: ".concat(currentProgress,"% (").concat(processedBlocks,"/").concat(totalBlocks,")"))}if(!isComplete&&batchResponse.result.next_offset&&(initialResponse.result.next_offset=batchResponse.result.next_offset),isComplete){console.log("All batches completed successfully!"),progress&&progress.setTarget(100);break}}},getfilterpluginstatus=async(pageType,pageLayout,subPage)=>_ajax.default.call([{methodname:"local_edwiserpagebuilder_get_filter_plugin_status",args:{config:""}}])[0],createProgressVisualization=_ref=>{let{progressBar:progressBar,progressText:progressText,onComplete:onComplete}=_ref,currentProgress=0,targetProgress=0,animationFrame=null,isAnimating=!1,lastUpdateTime=0,debounceTimer=null;const updateProgressDisplay=progressValue=>{const roundedProgress=Math.round(progressValue);if(progressBar&&(progressBar.style.width="".concat(progressValue,"%"),progressBar.setAttribute("aria-valuenow",roundedProgress)),progressText){const currentText=progressText.textContent,newText="".concat(roundedProgress,"%");currentText!==newText&&(progressText.textContent=newText)}},animateProgress=timestamp=>{lastUpdateTime||(lastUpdateTime=timestamp);const elapsed=timestamp-lastUpdateTime,progress=Math.min(elapsed/800,1),easeOutQuart=1-Math.pow(1-progress,4);updateProgressDisplay(currentProgress+(targetProgress-currentProgress)*easeOutQuart),progress<1?animationFrame=requestAnimationFrame(animateProgress):(currentProgress=targetProgress,updateProgressDisplay(currentProgress),isAnimating=!1,animationFrame=null)};return{start:()=>{currentProgress=2,targetProgress=2,isAnimating=!1,lastUpdateTime=0,animationFrame&&(cancelAnimationFrame(animationFrame),animationFrame=null),debounceTimer&&(clearTimeout(debounceTimer),debounceTimer=null),updateProgressDisplay(currentProgress),console.log("Progress visualization started at 2%")},setTarget:newTarget=>{newTarget=Math.max(0,Math.min(100,newTarget)),Math.abs(newTarget-targetProgress)<.1||(debounceTimer&&clearTimeout(debounceTimer),debounceTimer=setTimeout((()=>{console.log("Setting target progress from ".concat(targetProgress,"% to ").concat(newTarget,"%")),targetProgress=newTarget,isAnimating||(isAnimating=!0,lastUpdateTime=0,animationFrame=requestAnimationFrame(animateProgress))}),100))},complete:()=>{animationFrame&&(cancelAnimationFrame(animationFrame),animationFrame=null),debounceTimer&&(clearTimeout(debounceTimer),debounceTimer=null),targetProgress=100,isAnimating=!0,lastUpdateTime=0,console.log("Completing progress to 100%"),animationFrame=requestAnimationFrame(animateProgress),setTimeout((()=>{onComplete&&onComplete()}),900)},stop:()=>{animationFrame&&(cancelAnimationFrame(animationFrame),animationFrame=null),debounceTimer&&(clearTimeout(debounceTimer),debounceTimer=null),isAnimating=!1},getProgress:()=>currentProgress}},makeBatchRequest=(limit,offset)=>new Promise(((resolve,reject)=>{const args={};!1!==limit&&(args.limit=limit),offset>0&&(args.offset=offset),_ajax.default.call([{methodname:"local_edwiserpagebuilder_fetchblocks",args:args,done:function(response){let parsedResponse;console.log("Batch request successful:",response);try{parsedResponse="string"==typeof response?JSON.parse(response):response}catch(e){return console.error("Failed to parse JSON response:",e),void reject(new Error("Invalid JSON response"))}parsedResponse&&parsedResponse.result&&"object"==typeof parsedResponse.result?(console.log("Response validation passed, resolving with:",parsedResponse),resolve(parsedResponse)):(console.error("Invalid response structure:",parsedResponse),reject(new Error("Invalid response structure")))},fail:function(ex){console.error("Batch request failed:",ex),reject(ex)}}])}));_exports.init=function(pageType,pageLayout){let addBlockUrl=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,subPage=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",issiteadmin=arguments.length>4&&void 0!==arguments[4]&&arguments[4],edwepbf=arguments.length>5&&void 0!==arguments[5]&&arguments[5],pbfnotenable=arguments.length>6&&void 0!==arguments[6]&&arguments[6];edwepbf=0!=edwepbf,issiteadmin=0!=issiteadmin,pbfnotenable=0!=pbfnotenable,listenerEventsRegistered||(registerListenerEvents(pageType,pageLayout,addBlockUrl,subPage,issiteadmin,edwepbf,pbfnotenable),listenerEventsRegistered=!0)}}));

//# sourceMappingURL=addblockmodal.min.js.map