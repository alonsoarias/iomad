{"version":3,"file":"addblockmodal.min.js","sources":["../src/addblockmodal.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\n/* eslint-disable no-console*/\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Show an add block modal instead of doing it on a separate page.\n *\n * @module     core/addblockmodal\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'local_edwiserpagebuilder/jquery';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport { get_string as getString } from 'core/str';\nimport Ajax from 'core/ajax';\nimport blockmanager from 'local_edwiserpagebuilder/blockmanager';\n\nconst SELECTORS = {\n    ADD_BLOCK: '[data-key=\"addblock\"]',\n    MODAL_SUB_HEADER: '.modal-subheader',\n    MODAL_HEADER_TITLE: '.modal-header .modal-title'\n};\n\n// Ensure we only add our listeners once.\nlet listenerEventsRegistered = false;\n\n/**\n * Register related event listeners.\n *\n * @method registerListenerEvents\n * @param {String} pageType The type of the page\n * @param {String} pageLayout The layout of the page\n * @param {String|null} addBlockUrl The add block URL\n * @param {String} subPage The subpage identifier\n  * @param {String|null} issiteadmin check user is a site admin\n * @param {String} edwepbf check edwpbf plugin available or not\n * @param {Boolean} pbfnotenable check setting is enable or not\n */\nconst registerListenerEvents = async (pageType, pageLayout, addBlockUrl, subPage, issiteadmin, edwepbf, pbfnotenable) => {\n    document.addEventListener('click', e => {\n\n        const addBlock = e.target.closest(SELECTORS.ADD_BLOCK);\n        if (addBlock) {\n            e.preventDefault();\n\n            let addBlockModal = null;\n            let addBlockModalUrl = addBlockUrl ?? addBlock.dataset.url;\n\n            buildAddBlockModal()\n                .then(async modal => {\n                    modal.getRoot().addClass(\"epb_custom_modal\");\n\n                    const $root = modal.getRoot();\n                    const rootEl = $root.get(0);\n\n                    // === Step 1: define lock + unlock functions ===\n                    function lockModal() {\n                        $root.attr('data-backdrop', 'static');\n                        $root.attr('data-keyboard', 'false');\n\n                        // Prevent outside click\n                        $root.on(ModalEvents.outsideClick, preventOutsideClick);\n                        // Prevent ESC key\n                        if (rootEl) {\n                            rootEl.addEventListener('keydown', preventEscKey, true);\n                        }\n                    }\n\n                    function unlockModal() {\n                        $root.removeAttr('data-backdrop');\n                        $root.removeAttr('data-keyboard');\n\n                        // Allow outside click again\n                        $root.off(ModalEvents.outsideClick, preventOutsideClick);\n                        // Allow ESC again\n                        if (rootEl) {\n                            rootEl.removeEventListener('keydown', preventEscKey, true);\n                        }\n                    }\n\n                    function preventOutsideClick(e) {\n                        e.preventDefault();\n                    }\n\n                    function preventEscKey(e) {\n                        if (e && (e.key === 'Escape' || e.keyCode === 27 || e.which === 27)) {\n                            e.preventDefault();\n                            e.stopImmediatePropagation();\n                        }\n                    }\n                    modal.getRoot().on(ModalEvents.cancel, function (e) {\n                        e.preventDefault();\n                        modal.destroy();\n                    });\n                    addBlockModal = modal;\n\n                    // Render overlay immediately while we fetch in background\n                    Templates.render('local_edwiserpagebuilder/add_block_body_overlay', {})\n                    .then(overlay => {\n                        modal.setBody(overlay);\n                        // Lock only while overlay is active\n                        lockModal();\n                        modal.show();\n\n                        // Wait a bit for DOM to be ready, then start progress\n                        setTimeout(() => {\n                            const progressBar = document.querySelector(\"#add-block-overlay-bar\");\n                            const progressText = document.querySelector(\"#add-block-overlay-progress\");\n\n                            if (progressBar && progressText) {\n                                // Create and start progress visualization\n                                const progress = createProgressVisualization({\n                                    progressBar,\n                                    progressText,\n                                    onComplete: () => {\n                                        console.log(\"Progress visualization completed!\");\n                                    }\n                                });\n\n                                progress.start();\n\n                                // Fetch blocks and complete progress\n                                getFetchBlocks().then(fetchallblocks => {\n                                    // Complete the progress bar\n                                    progress.complete();\n\n                                    // Continue with your existing logic\n                                    const modalBody = renderBlocks(\n                                        addBlockModalUrl, pageType, pageLayout, subPage,\n                                        issiteadmin, edwepbf, pbfnotenable\n                                    );\n\n                                    modal.setBody(modalBody);\n                                    blockmanager.load(addBlockModalUrl, pageType);\n\n                                    // Unlock modal so user can close normally\n                                    unlockModal();\n\n                                    return modalBody;\n                                });\n                            }\n                        }, 150); // Small delay to ensure DOM is ready\n                    });\n                })\n                .catch(() => {\n                    addBlockModal.destroy();\n                });\n        }\n    });\n};\n\nconst moveSubheaderToMain = () => {\n    // Remove Sub Header and append in main header.\n    $(\".modal-header \" + SELECTORS.MODAL_SUB_HEADER).remove();\n    $($(SELECTORS.MODAL_SUB_HEADER)).insertAfter(SELECTORS.MODAL_HEADER_TITLE);\n    $(\".modal-body \" + SELECTORS.MODAL_SUB_HEADER).remove();\n    $(SELECTORS.MODAL_SUB_HEADER).removeClass(\"d-none\");\n};\n\nconst hideunactivetabdata = () =>{\n    $('.moodleblock').addClass('d-none');\n    $('.advanceblockblocks').removeClass('d-none');\n};\n/**\n * Method that creates the 'add block' modal.\n *\n * @method buildAddBlockModal\n * @returns {Promise} The modal promise (modal's body will be rendered later).\n */\nconst buildAddBlockModal = () => {\n    return ModalFactory.create({\n        type: ModalFactory.types.CANCEL,\n        title: getString('addblock')\n    });\n};\n\n/**\n * Method that renders the list of available blocks.\n *\n * @method renderBlocks\n * @param {String} addBlockUrl The add block URL\n * @param {String} pageType The type of the page\n * @param {String} pageLayout The layout of the page\n * @param {String} subPage The subpage identifier\n* @param {Boolean} issiteadmin The layout of the page\n * @param {Boolean} edwepbf check the edwpbf plugin exist\n * @param {Boolean} pbfnotenable check setting is enable or not\n * @return {Promise}\n */\nconst renderBlocks = async (addBlockUrl, pageType, pageLayout, subPage, issiteadmin, edwepbf, pbfnotenable) => {\n\n    // Fetch all addable blocks in the given page.\n    let blockscontext = await getAddableBlocks(pageType, pageLayout, subPage);\n    blockscontext = JSON.parse(blockscontext);\n\n\n    var filterplugindata = false;\n\n    var showfilterreleaseinfo = false;\n\n    if (edwepbf && !pbfnotenable) {\n\n        var filterplugindata = await getfilterpluginstatus();\n\n        filterplugindata = JSON.parse(filterplugindata);\n\n        if (filterplugindata.release <= '4.2.2' ) {\n            pbfnotenable = false;\n            showfilterreleaseinfo = true;\n        }\n    }\n    var showmodalsecondnav = false;\n    // The variable edwremuitheninfo is comming from theme using data for js\n    if ( typeof edwremuithemeinfo !== 'undefined' && edwremuithemeinfo == 'available') {\n        showmodalsecondnav = true;\n    }\n    var match = addBlockUrl.match(/[?&]bui_blockregion=([^&]+)/);\n    var region = match ? match[1] : \"\";\n    return Templates.render('local_edwiserpagebuilder/add_block_body', {\n        blockscontext: blockscontext?.blockscontext,\n        htmlblock: blockscontext?.htmlblock,\n        importblock: blockscontext?.importblock,\n        categories: blockscontext?.categories,\n        moodleblock: blockscontext.moodleblock,\n        url: addBlockUrl,\n        isadmin: issiteadmin,\n        pbfpluginexist: edwepbf,\n        edwpbfnotenable: pbfnotenable,\n        blockpagetype: pageType,\n        blockregion: region,\n        showsecondmenu: showmodalsecondnav,\n        showfilterreleasenotice:showfilterreleaseinfo\n    });\n};\n\n/**\n * Method that fetches all addable blocks in a given page.\n *\n * @method getAddableBlocks\n * @param {String} pageType The type of the page\n * @param {String} pageLayout The layout of the page\n * @param {String} subPage The subpage identifier\n * @return {Promise}\n */\nconst getAddableBlocks = async (pageType, pageLayout, subPage) => {\n    const request = {\n        methodname: 'local_edwiserpagebuilder_fetch_addable_blocks',\n        args: {\n            pagecontextid: M.cfg.contextid,\n            pagetype: pageType,\n            pagelayout: pageLayout,\n            subpage: subPage,\n        },\n    };\n\n    return Ajax.call([request])[0];\n};\n\n/**\n * Method that fetches all blocks using the fetchblocks web service with retry mechanism.\n *\n * @method getFetchBlocks\n * @param {Number} retryCount The current retry attempt number\n * @return {Promise}\n */\nconst getFetchBlocks = (retryCount = 1) => {\n    setTimeout(() => {\n        $(\"#add-block-installing-blocks-placeholder-wrapper\").removeClass(\"d-none\");\n    }, 400);\n\n    return new Promise((resolve, reject) => {\n        // Use an immediately invoked async function to handle async operations\n        (async () => {\n            try {\n                // Get progress elements\n                const progressBar = document.querySelector(\"#add-block-overlay-bar\");\n                const progressText = document.querySelector(\"#add-block-overlay-progress\");\n\n                // Create and start progress visualization\n                let progress;\n                if (progressBar && progressText) {\n                    progress = createProgressVisualization({\n                        progressBar,\n                        progressText,\n                        onComplete: () => {\n                            console.log(\"Progress visualization completed!\");\n                        }\n                    });\n                    progress.start();\n                }\n\n                // First request - check if batching is supported or if we should process all blocks\n                const initialResponse = await makeBatchRequest(20, 0);\n                console.log(\"Initial response:\", initialResponse);\n\n                if (initialResponse && initialResponse.result) {\n                    // Check if this is a batching response or a \"process all\" response\n                    if (initialResponse.result.limit > 0 && !initialResponse.result.complete) {\n                        // Batching mode - process in batches\n                        console.log(\"Batching mode detected, processing in batches...\");\n\n                        // Set initial progress based on first batch\n                        if (progress) {\n                            const initialProgress = Math.round((initialResponse.result.processed / initialResponse.result.total) * 100);\n                            progress.setTarget(initialProgress);\n                        }\n\n                        await processBatches(initialResponse, progressBar, progressText, progress);\n                    } else {\n                        // Backward compatibility mode - all blocks processed in one go\n                        console.log(\"Backward compatibility mode - all blocks processed\");\n                        if (progress) {\n                            progress.setTarget(100);\n                        }\n                    }\n                } else {\n                    console.error(\"Invalid initial response:\", initialResponse);\n                }\n\n                resolve(true);\n            } catch (error) {\n                console.error('Error in block fetching:', error);\n\n                // Retry logic\n                if (retryCount < 6) {\n                    console.log(\"Failed attempt: \" + error);\n                    setTimeout(() => {\n                        getFetchBlocks(retryCount + 1)\n                            .then(resolve)\n                            .catch(reject);\n                    }, 240000 * retryCount); // Wait 240 seconds before retrying\n                } else {\n                    resolve(false);\n                }\n            }\n        })();\n    });\n};\n\n/**\n * Backward compatibility function - fetches all blocks without batching (old behavior)\n * This maintains compatibility with existing code that doesn't pass parameters\n */\nconst getFetchBlocksLegacy = (retryCount = 1) => {\n    setTimeout(() => {\n        $(\"#add-block-installing-blocks-placeholder-wrapper\").removeClass(\"d-none\");\n    }, 400);\n\n    return new Promise((resolve, reject) => {\n        // Use an immediately invoked async function to handle async operations\n        (async () => {\n            try {\n                // Get progress elements\n                const progressBar = document.querySelector(\"#add-block-overlay-bar\");\n                const progressText = document.querySelector(\"#add-block-overlay-progress\");\n\n                // Create and start progress visualization\n                let progress;\n                if (progressBar && progressText) {\n                    progress = createProgressVisualization({\n                        progressBar,\n                        progressText,\n                        onComplete: () => {\n                            console.log(\"Progress visualization completed!\");\n                        }\n                    });\n                    progress.start();\n                }\n\n                // Call without parameters for backward compatibility\n                const response = await makeBatchRequest(false, 0);\n                console.log(\"Legacy response:\", response);\n\n                if (response && response.result) {\n                    // Show completion immediately for legacy mode\n                    if (progress) {\n                        progress.setTarget(100);\n                    }\n                    console.log(\"Legacy mode - all blocks processed\");\n                } else {\n                    console.error(\"Invalid legacy response:\", response);\n                }\n\n                resolve(true);\n            } catch (error) {\n                console.error('Error in legacy block fetching:', error);\n\n                // Retry logic\n                if (retryCount < 6) {\n                    console.log(\"Failed attempt: \" + error);\n                    setTimeout(() => {\n                        getFetchBlocksLegacy(retryCount + 1)\n                            .then(resolve)\n                            .catch(reject);\n                    }, 240000 * retryCount); // Wait 240 seconds before retrying\n                } else {\n                    resolve(false);\n                }\n            }\n        })();\n    });\n};\n\n/**\n * Process blocks in batches for the new batching system\n */\nconst processBatches = async (initialResponse, progressBar, progressText, progress) => {\n    let offset = 0;\n    const limit = 20;\n    let totalBlocks = initialResponse.result.total;\n    let processedBlocks = initialResponse.result.processed;\n    let isComplete = initialResponse.result.complete;\n\n    console.log(`Initial batch: ${processedBlocks}/${totalBlocks} blocks, Complete: ${isComplete}`);\n\n    // Continue with subsequent batches if not complete\n    let batchCount = 1;\n    while (!isComplete) {\n        batchCount++;\n        // Update offset for next batch\n        offset = initialResponse.result.next_offset;\n\n        console.log(`Making batch ${batchCount} request with offset: ${offset}`);\n\n        // Make next batch request\n        const batchResponse = await makeBatchRequest(limit, offset);\n        console.log(`Batch ${batchCount} response:`, batchResponse);\n\n        if (batchResponse && batchResponse.result) {\n            processedBlocks += batchResponse.result.processed;\n            isComplete = batchResponse.result.complete;\n\n            console.log(`Batch ${batchCount} completed: ${batchResponse.result.processed} blocks, Total processed: ${processedBlocks}/${totalBlocks}`);\n\n            // Update progress smoothly based on actual completion\n            if (progress) {\n                const currentProgress = Math.round((processedBlocks / totalBlocks) * 100);\n                progress.setTarget(currentProgress);\n                console.log(`Setting progress target to: ${currentProgress}% (${processedBlocks}/${totalBlocks})`);\n            }\n\n            // Update offset for next iteration if not complete\n            if (!isComplete && batchResponse.result.next_offset) {\n                initialResponse.result.next_offset = batchResponse.result.next_offset;\n            }\n\n            if (isComplete) {\n                console.log(\"All batches completed successfully!\");\n                // Set final progress to 100%\n                if (progress) {\n                    progress.setTarget(100);\n                }\n                break;\n            }\n        } else {\n            // Handle batch failure\n            console.error(`Batch ${batchCount} failed:`, batchResponse);\n            break;\n        }\n    }\n};\n\n/**\n * This method checks the version of filter plugin is more the 4.2.2 or not .\n *\n * @method getAddableBlocks\n * @param {String} pageType The type of the page\n * @param {String} pageLayout The layout of the page\n * @param {String} subPage The subpage identifier\n * @return {Promise}\n */\nconst getfilterpluginstatus = async (pageType, pageLayout, subPage) => {\n    const request = {\n        methodname: 'local_edwiserpagebuilder_get_filter_plugin_status',\n        args: {\n            config: \"\"\n        }\n    };\n\n    return Ajax.call([request])[0];\n};\n\n/**\n * Handles the progress bar visualization with stable, smooth progress\n * Prevents flickering and ensures progress bar and text stay in sync\n * @param {Object} options - Configuration options for the progress\n * @param {HTMLElement} options.progressBar - The progress bar element\n * @param {HTMLElement} options.progressText - The progress text element\n * @param {Function} options.onComplete - Callback when progress reaches 100%\n * @returns {Object} - Object with methods to control the progress\n */\nconst createProgressVisualization = ({ progressBar, progressText, onComplete }) => {\n    let currentProgress = 0;\n    let targetProgress = 0;\n    let animationFrame = null;\n    let isAnimating = false;\n    let lastUpdateTime = 0;\n    let debounceTimer = null;\n    const ANIMATION_DURATION = 800; // 800ms for smooth transitions\n    const DEBOUNCE_DELAY = 100; // 100ms debounce for target changes\n\n    // Ensure progress bar and text are always in sync\n    const updateProgressDisplay = (progressValue) => {\n        const roundedProgress = Math.round(progressValue);\n\n        // Update progress bar\n        if (progressBar) {\n            progressBar.style.width = `${progressValue}%`;\n            progressBar.setAttribute(\"aria-valuenow\", roundedProgress);\n        }\n\n        // Update progress text - only when there's a meaningful change\n        if (progressText) {\n            const currentText = progressText.textContent;\n            const newText = `${roundedProgress}%`;\n\n            // Only update text if it's different to prevent unnecessary DOM updates\n            if (currentText !== newText) {\n                progressText.textContent = newText;\n            }\n        }\n    };\n\n    // Smooth animation using requestAnimationFrame for better performance\n    const animateProgress = (timestamp) => {\n        if (!lastUpdateTime) lastUpdateTime = timestamp;\n\n        const elapsed = timestamp - lastUpdateTime;\n        const progress = Math.min(elapsed / ANIMATION_DURATION, 1);\n\n        // Use easing function for smooth animation\n        const easeOutQuart = 1 - Math.pow(1 - progress, 4);\n\n        // Calculate current position between start and target\n        const startProgress = currentProgress;\n        const progressDiff = targetProgress - startProgress;\n        const currentPosition = startProgress + (progressDiff * easeOutQuart);\n\n        // Update display\n        updateProgressDisplay(currentPosition);\n\n        // Continue animation if not complete\n        if (progress < 1) {\n            animationFrame = requestAnimationFrame(animateProgress);\n        } else {\n            // Animation complete\n            currentProgress = targetProgress;\n            updateProgressDisplay(currentProgress);\n            isAnimating = false;\n            animationFrame = null;\n        }\n    };\n\n    const startProgress = () => {\n        // Reset state\n        currentProgress = 2;\n        targetProgress = 2;\n        isAnimating = false;\n        lastUpdateTime = 0;\n\n        // Clear any existing animation and debounce\n        if (animationFrame) {\n            cancelAnimationFrame(animationFrame);\n            animationFrame = null;\n        }\n        if (debounceTimer) {\n            clearTimeout(debounceTimer);\n            debounceTimer = null;\n        }\n\n        // Set initial display\n        updateProgressDisplay(currentProgress);\n\n        console.log(\"Progress visualization started at 2%\");\n    };\n\n    const setTargetProgress = (newTarget) => {\n        // Ensure target is within valid range\n        newTarget = Math.max(0, Math.min(100, newTarget));\n\n        // Don't animate if target is the same or very close\n        if (Math.abs(newTarget - targetProgress) < 0.1) {\n            return;\n        }\n\n        // Clear existing debounce timer\n        if (debounceTimer) {\n            clearTimeout(debounceTimer);\n        }\n\n        // Debounce target changes to prevent rapid updates\n        debounceTimer = setTimeout(() => {\n            console.log(`Setting target progress from ${targetProgress}% to ${newTarget}%`);\n\n            // Update target\n            targetProgress = newTarget;\n\n            // Start animation if not already animating\n            if (!isAnimating) {\n                isAnimating = true;\n                lastUpdateTime = 0;\n                animationFrame = requestAnimationFrame(animateProgress);\n            }\n        }, DEBOUNCE_DELAY);\n    };\n\n    const completeProgress = () => {\n        // Clear any existing animation and debounce\n        if (animationFrame) {\n            cancelAnimationFrame(animationFrame);\n            animationFrame = null;\n        }\n        if (debounceTimer) {\n            clearTimeout(debounceTimer);\n            debounceTimer = null;\n        }\n\n        // Set final target and animate to 100%\n        targetProgress = 100;\n        isAnimating = true;\n        lastUpdateTime = 0;\n\n        console.log(\"Completing progress to 100%\");\n\n        // Animate to completion\n        animationFrame = requestAnimationFrame(animateProgress);\n\n        // Call onComplete after animation finishes\n        setTimeout(() => {\n            if (onComplete) onComplete();\n        }, ANIMATION_DURATION + 100);\n    };\n\n    const stopProgress = () => {\n        if (animationFrame) {\n            cancelAnimationFrame(animationFrame);\n            animationFrame = null;\n        }\n        if (debounceTimer) {\n            clearTimeout(debounceTimer);\n            debounceTimer = null;\n        }\n        isAnimating = false;\n    };\n\n    const getProgress = () => currentProgress;\n\n    return {\n        start: startProgress,\n        setTarget: setTargetProgress,\n        complete: completeProgress,\n        stop: stopProgress,\n        getProgress: getProgress\n    };\n};\n\n/**\n * Make a single batch request to the server.\n *\n * @param {Number|false} limit Number of blocks per batch, false for all blocks (backward compatibility)\n * @param {Number} offset Starting position for the batch\n * @return {Promise} Promise that resolves with the batch response\n */\nconst makeBatchRequest = (limit, offset) => {\n    return new Promise((resolve, reject) => {\n        const args = {};\n\n        // Only add parameters if they are meaningful (for backward compatibility)\n        if (limit !== false) {\n            args.limit = limit;\n        }\n        if (offset > 0) {\n            args.offset = offset;\n        }\n\n        Ajax.call([{\n            methodname: 'local_edwiserpagebuilder_fetchblocks',\n            args: args,\n            done: function(response) {\n                console.log(\"Batch request successful:\", response);\n\n                // Parse JSON response since PHP returns JSON string\n                let parsedResponse;\n                try {\n                    parsedResponse = typeof response === 'string' ? JSON.parse(response) : response;\n                } catch (e) {\n                    console.error(\"Failed to parse JSON response:\", e);\n                    reject(new Error(\"Invalid JSON response\"));\n                    return;\n                }\n\n                // Validate response structure\n                if (parsedResponse && parsedResponse.result && typeof parsedResponse.result === 'object') {\n                    console.log(\"Response validation passed, resolving with:\", parsedResponse);\n                    resolve(parsedResponse);\n                } else {\n                    console.error(\"Invalid response structure:\", parsedResponse);\n                    reject(new Error(\"Invalid response structure\"));\n                }\n            },\n            fail: function(ex) {\n                console.error(\"Batch request failed:\", ex);\n                reject(ex);\n            },\n        }]);\n    });\n};\n\n/**\n * Set up the actions.\n *\n * @method init\n * @param {String} pageType The type of the page\n * @param {String} pageLayout The layout of the page\n * @param {String|null} addBlockUrl The add block URL\n * @param {String} subPage The subpage identifier\n * @param {String|null} issiteadmin issiteadmin\n * @param {Boolean} edwepbf plugin avaialable\n *@param {Boolean} pbfnotenable plugin avaialable\n */\nexport const init = (\n    pageType, pageLayout, addBlockUrl = null, subPage = '', issiteadmin = false, edwepbf = false, pbfnotenable = false) => {\n    edwepbf = edwepbf == 0 ? false : true;\n    issiteadmin = issiteadmin == 0 ? false : true;\n    pbfnotenable = pbfnotenable == 0 ? false : true;\n    if (!listenerEventsRegistered) {\n        registerListenerEvents(pageType, pageLayout, addBlockUrl, subPage, issiteadmin, edwepbf, pbfnotenable);\n        listenerEventsRegistered = true;\n    }\n};\n"],"names":["SELECTORS","listenerEventsRegistered","registerListenerEvents","async","pageType","pageLayout","addBlockUrl","subPage","issiteadmin","edwepbf","pbfnotenable","document","addEventListener","e","addBlock","target","closest","preventDefault","addBlockModal","addBlockModalUrl","dataset","url","buildAddBlockModal","then","modal","getRoot","addClass","$root","rootEl","get","preventOutsideClick","preventEscKey","key","keyCode","which","stopImmediatePropagation","on","ModalEvents","cancel","destroy","render","overlay","setBody","attr","outsideClick","show","setTimeout","progressBar","querySelector","progressText","progress","createProgressVisualization","onComplete","console","log","start","getFetchBlocks","fetchallblocks","complete","modalBody","renderBlocks","load","removeAttr","off","removeEventListener","catch","ModalFactory","create","type","types","CANCEL","title","blockscontext","getAddableBlocks","JSON","parse","filterplugindata","showfilterreleaseinfo","getfilterpluginstatus","release","showmodalsecondnav","edwremuithemeinfo","match","region","Templates","_blockscontext","htmlblock","_blockscontext2","importblock","_blockscontext3","categories","_blockscontext4","moodleblock","isadmin","pbfpluginexist","edwpbfnotenable","blockpagetype","blockregion","showsecondmenu","showfilterreleasenotice","request","methodname","args","pagecontextid","M","cfg","contextid","pagetype","pagelayout","subpage","Ajax","call","retryCount","removeClass","Promise","resolve","reject","initialResponse","makeBatchRequest","result","limit","initialProgress","Math","round","processed","total","setTarget","processBatches","error","offset","totalBlocks","processedBlocks","isComplete","batchCount","next_offset","batchResponse","currentProgress","config","_ref","targetProgress","animationFrame","isAnimating","lastUpdateTime","debounceTimer","updateProgressDisplay","progressValue","roundedProgress","style","width","setAttribute","currentText","textContent","newText","animateProgress","timestamp","elapsed","min","easeOutQuart","pow","requestAnimationFrame","cancelAnimationFrame","clearTimeout","newTarget","max","abs","ANIMATION_DURATION","stop","getProgress","done","response","parsedResponse","Error","fail","ex"],"mappings":"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"}