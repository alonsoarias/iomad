/**
 * Audio recording utilities with WhatsApp-style interface and confirmation
 *
 * @module     mod_intebchat/audio
 * @copyright  2024 Eduardo Kraus
 * @copyright  2025 Enhanced by Alonso Arias
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_intebchat/audio",["jquery","core/str","core/modal_factory","core/modal_events"],(function($,Str,ModalFactory,ModalEvents){return{init:function(mode){let chunks=[],mediaRecorder=null,audioMode=mode||"text",stream=null,recordingStartTime=null,timerInterval=null,audioBlob=null,audioUrl=null,wasCancelled=!1;var strings={};function formatDuration(seconds){var minutes=Math.floor(seconds/60),secs=seconds%60;return(minutes<10?"0":"")+minutes+":"+(secs<10?"0":"")+secs}function updateTimer(){if(recordingStartTime){var display=formatDuration(Math.floor((Date.now()-recordingStartTime)/1e3));$(".recording-timer").text(display)}}function startRecording(){reset(),wasCancelled=!1,navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then((function(userStream){stream=userStream,mediaRecorder=new MediaRecorder(stream),chunks=[],mediaRecorder.start(),recordingStartTime=Date.now(),function(){if(0===$("#recording-overlay").length){var overlayHtml=`\n                        <div id="recording-overlay" class="recording-overlay">\n                            <div class="recording-container">\n                                <div class="recording-timer">00:00</div>\n                                <div class="recording-label">${strings.recordaudio||"Recording..."}</div>\n                                <div class="recording-wave">\n                                    <div class="wave-bar"></div>\n                                    <div class="wave-bar"></div>\n                                    <div class="wave-bar"></div>\n                                    <div class="wave-bar"></div>\n                                    <div class="wave-bar"></div>\n                                </div>\n                                <div class="recording-controls">\n                                    <button class="btn btn-cancel" id="cancel-recording">\n                                        <i class="fa fa-times"></i>\n                                    </button>\n                                    <button class="btn btn-stop" id="stop-recording">\n                                        <i class="fa fa-stop"></i>\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n                    `;$("body").append(overlayHtml)}}(),$("#recording-overlay").addClass("active"),timerInterval=setInterval(updateTimer,100),$("#intebchat-icon-mic").addClass("recording").hide(),$("#intebchat-icon-stop").show(),mediaRecorder.ondataavailable=function(e){e.data&&e.data.size>0&&chunks.push(e.data)},mediaRecorder.onstop=function(){if(chunks.length>0&&!wasCancelled){audioBlob=new Blob(chunks,{type:"audio/webm"}),audioUrl=URL.createObjectURL(audioBlob);var reader=new FileReader;reader.readAsDataURL(audioBlob),reader.onloadend=function(){var audioDataUrl,audioPreviewHtml;reader.result&&(wasCancelled||(audioDataUrl=reader.result,audioPreviewHtml=`\n                    <div class="audio-confirmation-content">\n                        <p>${strings.confirmaudiosend}</p>\n                        <audio controls src="${audioUrl}" style="width: 100%; margin: 20px 0;"></audio>\n                        <div class="audio-duration" style="text-align: center; color: #666;">\n                            Duration: ${formatDuration(recordingStartTime?Math.floor((Date.now()-recordingStartTime)/1e3):0)}\n                        </div>\n                    </div>\n                `,ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings.audiorecorded,body:audioPreviewHtml,buttons:{save:strings.send,cancel:strings.rerecord}}).then((function(modal){return modal.show(),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),$("#intebchat-recorded-audio").val(audioDataUrl),"audio"!==audioMode&&"both"!==audioMode||setTimeout((function(){$("#intebchat-icon-stop").trigger("audio-ready")}),100),modal.destroy()})),modal.getRoot().on(ModalEvents.cancel,(function(e){e.preventDefault(),reset(),modal.destroy()})),modal.getRoot().on(ModalEvents.hidden,(function(){audioUrl&&(URL.revokeObjectURL(audioUrl),audioUrl=null)})),modal})).catch((function(error){console.error("Error creating modal:",error),confirm(strings.confirmaudiosend)?($("#intebchat-recorded-audio").val(audioDataUrl),"audio"!==audioMode&&"both"!==audioMode||setTimeout((function(){$("#intebchat-icon-stop").trigger("audio-ready")}),100)):reset()}))))}}chunks=[],stream&&(stream.getTracks().forEach((track=>track.stop())),stream=null),wasCancelled=!1},mediaRecorder.onerror=function(e){alert("Error during recording: "+e.error),reset()}})).catch((function(err){alert("Error accessing microphone: "+err.message),reset()})):alert("Your browser does not support recording!")}function stopRecording(){mediaRecorder&&"inactive"!==mediaRecorder.state&&(wasCancelled=!1,mediaRecorder.stop(),mediaRecorder=null),$("#recording-overlay").removeClass("active"),timerInterval&&(clearInterval(timerInterval),timerInterval=null),$("#intebchat-icon-mic").show().removeClass("recording"),$("#intebchat-icon-stop").hide()}function cancelRecording(){mediaRecorder&&"inactive"!==mediaRecorder.state&&(wasCancelled=!0,mediaRecorder.stop(),mediaRecorder=null),$("#intebchat-recorded-audio").val(""),chunks=[],$("#recording-overlay").removeClass("active"),timerInterval&&(clearInterval(timerInterval),timerInterval=null),recordingStartTime=null,stream&&(stream.getTracks().forEach((track=>track.stop())),stream=null),audioUrl&&(URL.revokeObjectURL(audioUrl),audioUrl=null),$("#intebchat-icon-mic").show().removeClass("recording"),$("#intebchat-icon-stop").hide()}function reset(){$("#intebchat-icon-mic").removeClass("recording").show(),$("#intebchat-icon-stop").hide(),$("#intebchat-recorded-audio").val(""),$("#recording-overlay").removeClass("active"),timerInterval&&(clearInterval(timerInterval),timerInterval=null),recordingStartTime=null,stream&&(stream.getTracks().forEach((track=>track.stop())),stream=null),audioUrl&&(URL.revokeObjectURL(audioUrl),audioUrl=null),audioBlob=null,chunks=[],wasCancelled=!1}Str.get_strings([{key:"recordaudio",component:"mod_intebchat"},{key:"stoprecording",component:"mod_intebchat"},{key:"cancel",component:"core"},{key:"send",component:"core"},{key:"audiorecorded",component:"mod_intebchat"},{key:"confirmaudiosend",component:"mod_intebchat"},{key:"playaudio",component:"mod_intebchat"},{key:"rerecord",component:"mod_intebchat"}]).then((function(results){strings.recordaudio=results[0],strings.stoprecording=results[1],strings.cancel=results[2],strings.send=results[3]||"Send",strings.audiorecorded=results[4]||"Audio Recorded",strings.confirmaudiosend=results[5]||"Do you want to send this audio?",strings.playaudio=results[6]||"Play Audio",strings.rerecord=results[7]||"Re-record"})),$("#intebchat-icon-mic").on("click",(function(){startRecording()})),$("#intebchat-icon-stop").on("click",(function(){stopRecording()})),$(document).on("click","#stop-recording",(function(){stopRecording()})),$(document).on("click","#cancel-recording",(function(){cancelRecording()})),$(document).on("keydown",(function(e){27===e.keyCode&&$("#recording-overlay").hasClass("active")&&cancelRecording()}))}}}));

//# sourceMappingURL=audio.min.js.map