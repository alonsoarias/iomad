/**
 * Main JavaScript for INTEB Chat module with Conversations Management
 *
 * @module     mod_intebchat/lib
 * @copyright  2025 Alonso Arias <soporte@ingeweb.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_intebchat/lib",["jquery","core/ajax","core/str","core/notification","core/modal_save_cancel","core/modal_delete_cancel","core/templates"],(function($,Ajax,Str,Notification,ModalSaveCancel,ModalDeleteCancel,Templates){var questionString="Ask a question...",errorString="An error occurred! Please try again later.",currentConversationId=null,currentInputMode="text",lastInputMode="text",tokenInfo={enabled:!1,limit:0,used:0,exceeded:!1,resetTime:0},strings={},audioConfig={enabled:!1,mode:"text"},TokenTracker={used:0,limit:0,audioUsed:0,textUsed:0,init:function(initialUsed,limit){this.used=initialUsed,this.limit=limit,this.updateDisplay()},addTokens:function(tokenInfo){tokenInfo&&(this.used+=tokenInfo.total||0,(tokenInfo.audio_input||tokenInfo.audio_output)&&(this.audioUsed+=(tokenInfo.audio_input||0)+(tokenInfo.audio_output||0)),(tokenInfo.prompt||tokenInfo.completion)&&(this.textUsed+=(tokenInfo.prompt||0)+(tokenInfo.completion||0)-((tokenInfo.audio_input||0)+(tokenInfo.audio_output||0))),this.updateDisplay(),this.checkLimits())},updateDisplay:function(){var percentage=this.limit>0?this.used/this.limit*100:0;$(".token-count").text(percentage.toFixed(1)+"%"),$(".progress-bar").css("width",Math.min(percentage,100)+"%"),(this.audioUsed>0||this.textUsed>0)&&($("#token-breakdown").length||$(".token-display").after('<div id="token-breakdown" class="token-breakdown"><small>'+strings.texttokens+': <span id="text-tokens">0</span> | '+strings.audiotokens+': <span id="audio-tokens">0</span></small></div>'),$("#text-tokens").text(this.textUsed.toLocaleString()),$("#audio-tokens").text(this.audioUsed.toLocaleString())),$(".progress-bar").removeClass("warning danger"),percentage>=90?$(".progress-bar").addClass("danger"):percentage>75&&$(".progress-bar").addClass("warning")},checkLimits:function(){var percentage=this.limit>0?this.used/this.limit*100:0;if(percentage>=100)$("#openai_input").prop("disabled",!0),$("#go").prop("disabled",!0),$("#intebchat-icon-mic").prop("disabled",!0),$(".token-limit-alert").length||$("#intebchat_log").before('<div class="alert alert-danger token-limit-alert"><i class="fa fa-exclamation-circle"></i> '+strings.tokenlimitexceeded+"</div>");else if(percentage>90){var remaining=this.limit-this.used;$(".token-warning-alert").length||$("#intebchat_log").before('<div class="alert alert-warning token-warning-alert"><i class="fa fa-exclamation-triangle"></i> '+strings.tokenlimitwarning.replace("{$a}",remaining)+"</div>")}}},AnimatedAssistant={init:function(){$(".intebchat-main").append('<div id="intebchat-assistant" class="intebchat-assistant"><div class="assistant-body"><div class="assistant-eyes"><div class="eye left"></div><div class="eye right"></div></div><div class="assistant-mouth"></div></div><div class="assistant-bubble" style="display:none;"></div></div>'),this.bindEvents(),this.idle(),console.log("Assistant initialized")},bindEvents:function(){var self=this;$(document).on("click","#intebchat-assistant",(function(){self.wave()}))},idle:function(){$("#intebchat-assistant").removeClass("thinking talking waving").addClass("idle"),this.blink()},thinking:function(){$("#intebchat-assistant").removeClass("idle talking waving").addClass("thinking"),this.showBubble("ðŸ¤” Thinking...")},talking:function(){$("#intebchat-assistant").removeClass("idle thinking waving").addClass("talking"),this.hideBubble()},wave:function(){var self=this;$("#intebchat-assistant").removeClass("idle thinking talking").addClass("waving"),setTimeout((function(){self.idle()}),1e3)},showBubble:function(text){$(".assistant-bubble").text(text).fadeIn(200)},hideBubble:function(){$(".assistant-bubble").fadeOut(200)},blink:function(){this.blinkInterval&&clearInterval(this.blinkInterval),this.blinkInterval=setInterval((function(){$(".assistant-eyes").addClass("blinking"),setTimeout((function(){$(".assistant-eyes").removeClass("blinking")}),150)}),3e3+2e3*Math.random())}},initDarkMode=function(instanceId){var $container=$(".mod_intebchat"),themeKey="intebchat_theme_"+instanceId+"_"+(M.cfg.sesskey||"default"),savedTheme=localStorage.getItem(themeKey),prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;"dark"===savedTheme||null===savedTheme&&prefersDark?($container.addClass("dark-mode"),$("#theme-toggle-btn i").removeClass("fa-sun").addClass("fa-moon")):($container.removeClass("dark-mode"),$("#theme-toggle-btn i").removeClass("fa-moon").addClass("fa-sun")),$(document).on("click","#theme-toggle-btn",(function(e){e.preventDefault(),$container.hasClass("dark-mode")?($container.removeClass("dark-mode"),localStorage.setItem(themeKey,"light"),$(this).find("i").removeClass("fa-moon").addClass("fa-sun"),$(this).attr("title",strings.darkmode||"Switch to dark mode")):($container.addClass("dark-mode"),localStorage.setItem(themeKey,"dark"),$(this).find("i").removeClass("fa-sun").addClass("fa-moon"),$(this).attr("title",strings.lightmode||"Switch to light mode"))})),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(function(e){null===localStorage.getItem(themeKey)&&(e.matches?($container.addClass("dark-mode"),$("#theme-toggle-btn i").removeClass("fa-sun").addClass("fa-moon")):($container.removeClass("dark-mode"),$("#theme-toggle-btn i").removeClass("fa-moon").addClass("fa-sun")))}))},sendAudioMessage=function(instanceId,api_type){if($("#intebchat-recorded-audio").val()){var doSend=function(){var responseMode="both"===audioConfig.mode?lastInputMode:audioConfig.mode;addToChatLog("user transcribing",'<div class="transcribing-animation"><i class="fa fa-microphone pulse"></i> <span class="dots"><span>.</span><span>.</span><span>.</span></span> '+(strings.transcribing||"Transcribing...")+"</div>",instanceId),AnimatedAssistant.thinking(),createCompletion("",instanceId,api_type,responseMode)};currentConversationId?doSend():Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),doSend()}}])}},loadStrings=function(){return Str.get_strings([{key:"askaquestion",component:"mod_intebchat"},{key:"erroroccurred",component:"mod_intebchat"},{key:"newconversation",component:"mod_intebchat"},{key:"confirmclear",component:"mod_intebchat"},{key:"conversationcleared",component:"mod_intebchat"},{key:"loadingconversation",component:"mod_intebchat"},{key:"edittitle",component:"mod_intebchat"},{key:"clearconversation",component:"mod_intebchat"},{key:"cancel",component:"core"},{key:"save",component:"core"},{key:"delete",component:"core"},{key:"conversationtitle",component:"mod_intebchat"},{key:"confirmclearmessage",component:"mod_intebchat"},{key:"transcribing",component:"mod_intebchat"},{key:"switchtoaudiomode",component:"mod_intebchat"},{key:"switchtotextmode",component:"mod_intebchat"},{key:"tokenlimitexceeded",component:"mod_intebchat"},{key:"switchtheme",component:"mod_intebchat"},{key:"darkmode",component:"mod_intebchat"},{key:"lightmode",component:"mod_intebchat"},{key:"texttokens",component:"mod_intebchat"},{key:"audiotokens",component:"mod_intebchat"},{key:"tokenlimitwarning",component:"mod_intebchat"},{key:"reasoningmodelwarning",component:"mod_intebchat"},{key:"conversationtitleupdated",component:"mod_intebchat"}]).then((function(results){strings.askaquestion=results[0],strings.erroroccurred=results[1],strings.newconversation=results[2],strings.confirmclear=results[3],strings.conversationcleared=results[4],strings.loadingconversation=results[5],strings.edittitle=results[6],strings.clearconversation=results[7],strings.cancel=results[8],strings.save=results[9],strings.delete=results[10],strings.conversationtitle=results[11],strings.confirmclearmessage=results[12],strings.transcribing=results[13],strings.switchtoaudiomode=results[14],strings.switchtotextmode=results[15],strings.tokenlimitexceeded=results[16],strings.switchtheme=results[17],strings.darkmode=results[18],strings.lightmode=results[19],strings.texttokens=results[20],strings.audiotokens=results[21],strings.tokenlimitwarning=results[22],strings.reasoningmodelwarning=results[23],strings.conversationtitleupdated=results[24],questionString=strings.askaquestion,errorString=strings.erroroccurred}))},showEditTitleModal=function(conversationId){var currentTitle=$("#conversation-title").text();ModalSaveCancel.create({title:strings.edittitle,body:'<div class="form-group"><label for="conversation-title-input">'+strings.conversationtitle+'</label><input type="text" class="form-control" id="conversation-title-input" value="'+currentTitle.replace(/"/g,"&quot;")+'"></div>',buttons:{save:strings.save,cancel:strings.cancel},show:!0,removeOnClose:!0}).then((function(modal){var root=modal.getRoot();return root.on("modal-save-cancel:save",(function(e){e.preventDefault();var newTitle=$("#conversation-title-input").val().trim();newTitle&&newTitle!==currentTitle&&updateConversationTitle(conversationId,newTitle),modal.destroy()})),root.on("shown.bs.modal",(function(){$("#conversation-title-input").focus().select()})),root.on("keypress","#conversation-title-input",(function(e){13===e.which&&(e.preventDefault(),root.find('[data-action="save"]').trigger("click"))})),modal})).catch(Notification.exception)},showClearConversationModal=function(conversationId,instanceId){ModalDeleteCancel.create({title:strings.clearconversation,body:"<p>"+strings.confirmclearmessage+"</p>",buttons:{delete:strings.delete,cancel:strings.cancel},show:!0,removeOnClose:!0}).then((function(modal){var root=modal.getRoot();return root.on("modal-delete-cancel:delete",(function(e){e.preventDefault(),clearConversation(conversationId,instanceId),modal.destroy()})),root.on("modal-delete-cancel:cancel",(function(e){e.preventDefault(),modal.destroy()})),modal})).catch(Notification.exception)},initializeConversations=function(instanceId){var firstConversation=$(".intebchat-conversation-item").first();firstConversation.length>0&&firstConversation.click()},createNewConversation=function(instanceId){Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#intebchat_log").empty(),$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),$("#openai_input").length&&$("#openai_input").focus(),AnimatedAssistant.wave()},fail:function(error){Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},loadConversation=function(conversationId,instanceId){$("#intebchat_log").html('<div class="loading-conversation text-center p-4"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div> '+strings.loadingconversation+"</div>"),Ajax.call([{methodname:"mod_intebchat_load_conversation",args:{conversationid:conversationId,instanceid:instanceId},done:function(response){console.log("Conversation loaded:",response),currentConversationId=conversationId,$("#conversation-title").text(response.title),$("#intebchat_log").empty(),response.messages&&response.messages.length>0&&response.messages.forEach((function(msg){var clean=stripAutoplay(msg.message);addToChatLog("user"===msg.role?"user":"bot",clean,instanceId,!1)})),response.threadId&&$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').attr("data-thread-id",response.threadId),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').addClass("active"),$("#conversations-sidebar").removeClass("mobile-open");var messageContainer=$("#intebchat_log");messageContainer.animate({scrollTop:messageContainer[0].scrollHeight},300),$("#openai_input").focus(),AnimatedAssistant.idle()},fail:function(error){console.error("Error loading conversation:",error),$("#intebchat_log").empty();var errorMessage=strings.erroroccurred;error.message?errorMessage=error.message:error.error&&(errorMessage=error.error),addToChatLog("bot error",errorMessage,instanceId),Notification.addNotification({message:errorMessage,type:"error"})}}])},clearConversation=function(conversationId,instanceId){Ajax.call([{methodname:"mod_intebchat_clear_conversation",args:{conversationid:conversationId},done:function(response){if(console.log("Clear conversation response:",response),response.deleted)$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]').fadeOut(300,(function(){if($(this).remove(),0===$(".intebchat-conversation-item").length)createNewConversation(instanceId);else{var firstConv=$(".intebchat-conversation-item").first();firstConv.length>0&&firstConv.click()}})),Notification.addNotification({message:strings.conversationcleared,type:"success"});else{$("#intebchat_log").empty();var $conversationItem=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');$conversationItem.find(".intebchat-conversation-preview").text(""),$conversationItem.removeAttr("data-thread-id"),Notification.addNotification({message:strings.conversationcleared,type:"success"})}},fail:function(error){console.error("Error clearing conversation:",error),Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},updateConversationTitle=function(conversationId,newTitle){newTitle&&""!==newTitle.trim()&&Ajax.call([{methodname:"mod_intebchat_update_conversation_title",args:{conversationid:conversationId,title:newTitle},done:function(response){if(console.log("Title update response:",response),response&&response.success){$("#conversation-title").text(newTitle);var $item=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');$item.find(".title-text").text(newTitle),$item.attr("data-title",newTitle),Notification.addNotification({message:strings.conversationtitleupdated||"Title updated successfully",type:"success"})}else Notification.addNotification({message:strings.erroroccurred,type:"error"})},fail:function(error){console.error("Error updating title:",error),Notification.addNotification({message:error.message||strings.erroroccurred,type:"error"})}}])},filterConversations=function(searchTerm){searchTerm=searchTerm.toLowerCase(),$(".intebchat-conversation-item").each((function(){var title=$(this).find(".title-text").text().toLowerCase(),preview=$(this).find(".intebchat-conversation-preview").text().toLowerCase();title.includes(searchTerm)||preview.includes(searchTerm)?$(this).show():$(this).hide()}))},createConversationListItem=function(conversation){var dateStr=new Date(1e3*conversation.lastmessage).toLocaleDateString([],{day:"2-digit",month:"2-digit"});return'<div class="intebchat-conversation-item" data-conversation-id="'+conversation.conversationid+'" data-title="'+conversation.title+'"><div class="intebchat-conversation-title"><span class="title-text">'+conversation.title+'</span><span class="intebchat-conversation-date">'+dateStr+'</span></div><div class="intebchat-conversation-preview">'+conversation.preview+"</div></div>"},sendMessage=function(message,instanceId,api_type){if(currentConversationId){addToChatLog("user",message,instanceId),AnimatedAssistant.thinking();var responseMode="both"===audioConfig.mode?lastInputMode:"text";createCompletion(message,instanceId,api_type,responseMode)}else Ajax.call([{methodname:"mod_intebchat_create_conversation",args:{instanceid:instanceId},done:function(response){currentConversationId=response.conversationid,$("#conversation-title").text(response.title);var conversationHtml=createConversationListItem(response);$(".intebchat-no-conversations").length>0?$(".intebchat-conversations-list").html(conversationHtml):$(".intebchat-conversations-list").prepend(conversationHtml),$(".intebchat-conversation-item").removeClass("active"),$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').addClass("active"),addToChatLog("user",message,instanceId),AnimatedAssistant.thinking();var responseMode="both"===audioConfig.mode?lastInputMode:"text";createCompletion(message,instanceId,api_type,responseMode)},fail:function(error){Notification.addNotification({message:error.message||errorString,type:"error"})}}])},updateTokenUI=function(){if(tokenInfo.enabled){var $container=$(".mod_intebchat"),$input=$container.find("#openai_input"),$submitBtn=$container.find("#go"),$progressBar=$container.find(".progress-bar");if(tokenInfo.exceeded?($input.prop("disabled",!0),$submitBtn.prop("disabled",!0)):($input.prop("disabled",!1),$submitBtn.prop("disabled",!1)),$progressBar.length){var percentage=tokenInfo.used/tokenInfo.limit*100;$progressBar.css("width",percentage+"%"),$progressBar.removeClass("warning danger"),percentage>90?$progressBar.addClass("danger"):percentage>75&&$progressBar.addClass("warning")}}},checkTokenReset=function(){var now=Date.now()/1e3;tokenInfo.exceeded&&now>tokenInfo.resetTime&&window.location.reload()};function stripAutoplay(html){var container=$("<div></div>").html(html);return container.find("audio").each((function(){$(this).removeAttr("autoplay"),this.autoplay=!1})),container.html()}var addToChatLog=function(type,message,instanceId){let animate=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log');"user transcribing"!==type&&messageContainer.find(".openai_message.transcribing").remove();var messageElem=$("<div></div>").addClass("openai_message").addClass(type.replace(" ","-"));if("bot"===type&&animate){messageElem.addClass("typing");var messageText=$("<span></span>").addClass("message-content"),cursor=$('<span class="typing-cursor">|</span>');messageText.append(cursor),messageElem.append(messageText);var fullMessage=message,currentIndex=0,typingSpeed=30;messageContainer.append(messageElem);var typeWriter=function(){if(currentIndex<fullMessage.length){var char=fullMessage.charAt(currentIndex);if("<"===char){var tagEnd=fullMessage.indexOf(">",currentIndex);if(-1!==tagEnd){var tag=fullMessage.substring(currentIndex,tagEnd+1);cursor.before(tag),currentIndex=tagEnd+1}else cursor.before(char),currentIndex++}else cursor.before(char),currentIndex++;setTimeout(typeWriter,typingSpeed)}else cursor.remove(),messageElem.removeClass("typing"),AnimatedAssistant.idle()};typeWriter()}else{"bot"===type&&animate||(message=stripAutoplay(message));messageText=$("<span></span>").html(message);messageElem.append(messageText),animate?(messageElem.hide(),messageContainer.append(messageElem),messageElem.fadeIn(300)):messageContainer.append(messageElem)}var timestamp=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),timestampElem=$("<span></span>").addClass("message-timestamp").text(timestamp);messageElem.append(timestampElem),messageContainer.animate({scrollTop:messageContainer[0].scrollHeight},300)},createCompletion=function(message,instanceId,api_type,responseMode){var threadId=null;if(currentConversationId){var $conversationItem=$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]');$conversationItem.length&&$conversationItem.data("thread-id")&&(threadId=$conversationItem.data("thread-id"))}var history=buildTranscript(instanceId);$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').addClass("disabled"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').removeClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",questionString),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').blur(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message.transcribing').length||addToChatLog("bot loading",'<div class="loading-dots"><span></span><span></span><span></span></div>',instanceId);var audio=$("#intebchat-recorded-audio").val(),requestData={message:message,history:history,instanceId:instanceId,conversationId:currentConversationId||null,threadId:threadId,audio:audio||null,responseMode:responseMode||"text"};console.log("Sending completion request:",requestData),$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/completion.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(requestData),success:function(data){console.log("Completion response:",data),$("#intebchat-recorded-audio").val("");var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log');if(messageContainer.find(".openai_message.bot-loading, .openai_message.user-transcribing").remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled"),data.message){if(audio&&data.transcription){messageContainer.find(".openai_message.user-transcribing").remove();var userContent=data.transcription;data.useraudio&&(userContent='<audio controls src="'+data.useraudio+'"></audio><div class="transcription">'+data.transcription+"</div>"),addToChatLog("user",userContent,instanceId)}addToChatLog("bot",data.message,instanceId),AnimatedAssistant.talking(),setTimeout((function(){AnimatedAssistant.idle()}),2e3),data.conversationId&&!currentConversationId&&(currentConversationId=data.conversationId),data.threadId&&currentConversationId&&$('.intebchat-conversation-item[data-conversation-id="'+currentConversationId+'"]').attr("data-thread-id",data.threadId),currentConversationId&&updateConversationPreview(currentConversationId,data.transcription||message),data.tokenInfo&&tokenInfo.enabled&&TokenTracker.addTokens(data.tokenInfo)}else data.error&&(console.error("Server error:",data.error),"token_limit_exceeded"===data.error.type?(tokenInfo.exceeded=!0,updateTokenUI(),Notification.addNotification({message:data.error.message,type:"error"})):addToChatLog("bot error",data.error.message,instanceId),AnimatedAssistant.idle());$("#openai_input").length&&$("#openai_input").focus()},error:function(xhr,status,error){console.error("AJAX error:",status,error,xhr.responseText),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').find(".openai_message.bot-loading, .openai_message.user-transcribing").remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled");var errorMsg=errorString;try{var response=JSON.parse(xhr.responseText);response.error&&(errorMsg=response.error.message||response.error)}catch(e){errorMsg=errorString+" ("+error+")"}addToChatLog("bot error",errorMsg,instanceId),AnimatedAssistant.idle(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').addClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",errorString)}})},updateConversationPreview=function(conversationId,lastMessage){if(lastMessage){var $item=$('.intebchat-conversation-item[data-conversation-id="'+conversationId+'"]');if($item.length){$item.find(".intebchat-conversation-preview").text(lastMessage);var now=new Date;$item.find(".intebchat-conversation-date").text(now.toLocaleDateString([],{day:"2-digit",month:"2-digit"})),$item.is(":first-child")||$item.fadeOut(200,(function(){$(this).prependTo(".intebchat-conversations-list").fadeIn(200)}))}}},buildTranscript=function(instanceId){var transcript=[];return $('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').each((function(index,element){if(index!==$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').length-1){var user=userName;$(element).hasClass("bot")&&(user=assistantName);var messageText=$(element).clone();messageText.find(".message-timestamp").remove(),messageText.find("audio").remove(),messageText.find(".transcription").remove(),transcript.push({user:user,message:messageText.text().trim()})}})),transcript};return{init:function(data){console.log("INTEBCHAT: Initializing with data:",data);var instanceId=data.instanceId,api_type=data.api_type;data.persistConvo;tokenInfo.enabled=data.tokenLimitEnabled||!1,tokenInfo.limit=data.tokenLimit||0,tokenInfo.used=data.tokensUsed||0,tokenInfo.exceeded=data.tokenLimitExceeded||!1,tokenInfo.resetTime=data.resetTime||0,audioConfig.enabled=data.audioEnabled||!1,audioConfig.mode=data.audioMode||"text","both"===audioConfig.mode&&(currentInputMode=sessionStorage.getItem("intebchat_input_mode_"+instanceId)||"text",lastInputMode=currentInputMode),updateTokenUI(),initDarkMode(instanceId),loadStrings().then((function(){initializeConversations(instanceId),$("#openai_input").length&&$("#openai_input").attr("placeholder",strings.askaquestion),setTimeout((function(){AnimatedAssistant.init()}),500)})),tokenInfo.enabled&&(TokenTracker.init(tokenInfo.used,tokenInfo.limit),$(document).ajaxComplete((function(event,xhr,settings){if(settings.url&&settings.url.includes("/mod/intebchat/api/completion.php"))try{var response=JSON.parse(xhr.responseText);response.tokenInfo&&TokenTracker.addTokens(response.tokenInfo)}catch(e){console.error("Error processing token info:",e)}}))),"text"!==audioConfig.mode&&"both"!==audioConfig.mode||($(document).on("keyup",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){13!==e.which||e.shiftKey||(e.preventDefault(),""===e.target.value||tokenInfo.exceeded||(lastInputMode="text",sendMessage(e.target.value,instanceId,api_type),e.target.value=""))})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #go',(function(e){var input=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input');tokenInfo.exceeded||""===input.val()||(lastInputMode="text",sendMessage(input.val(),instanceId,api_type),input.val(""))}))),audioConfig.enabled&&("audio"!==audioConfig.mode&&"both"!==audioConfig.mode||$(document).on("audio-ready","#intebchat-icon-stop",(function(){$("#intebchat-recorded-audio").val()&&!tokenInfo.exceeded&&(lastInputMode="audio",setTimeout((function(){sendAudioMessage(instanceId,api_type)}),100))}))),$(document).on("click","#new-conversation-btn",(function(e){createNewConversation(instanceId)})),$(document).on("click","#clear-conversation-btn",(function(e){e.preventDefault(),currentConversationId&&showClearConversationModal(currentConversationId,instanceId)})),$(document).on("click","#edit-title-btn",(function(e){e.preventDefault(),currentConversationId&&showEditTitleModal(currentConversationId)})),$(document).on("click",".intebchat-conversation-item",(function(e){var conversationId=$(this).data("conversation-id");loadConversation(conversationId,instanceId)})),$(document).on("input","#conversation-search",(function(e){filterConversations(e.target.value)})),$(document).on("click","#mobile-menu-toggle",(function(e){$("#conversations-sidebar").toggleClass("mobile-open")})),$("#openai_input").length&&$(document).on("input",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),tokenInfo.enabled&&setInterval(checkTokenReset,6e4),0===$(".intebchat-conversation-item").length&&createNewConversation(instanceId)}}}));

//# sourceMappingURL=lib.min.js.map